<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>かものはし家計簿</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <style>
        :root{--primary-color:#2e7d32;--primary-dark-variant:#266b2a;--primary-light-variant:#5cb85c;--background-light:#f8f8f8;--background-dark:#121212;--card-bg-light:#fff;--card-bg-dark:#1e1e1e;--text-color-light:#333;--text-color-dark:#e0e0e0;--border-color-light:#e0e0e0;--border-color-dark:#444}body{margin:0;font-family:'Noto Sans JP',sans-serif;padding-bottom:90px;background-color:var(--background-light);color:var(--text-color-light)}@media (prefers-color-scheme:dark){body{background-color:var(--background-dark);color:var(--text-color-dark)}section{background-color:var(--card-bg-dark)}input,select,button{background-color:var(--card-bg-dark);color:var(--text-color-dark);border-color:var(--border-color-dark)}table,th,td{border-color:var(--border-color-dark)}}header{display:flex;align-items:center;justify-content:center;padding:1rem;background-color:var(--primary-dark-variant);color:#fff;width:100%;box-shadow:0 4px 6px rgba(0,0,0,.1);max-width:48rem;margin:0 auto;border-bottom-left-radius:.75rem;border-bottom-right-radius:.75rem}header img{width:64px;height:64px;margin-right:1rem}header h1{font-size:1.75rem;font-weight:700;margin:0}main{display:flex;flex-direction:column;align-items:center;width:100%;max-width:48rem;margin:2rem auto;padding:0 1rem}section{background-color:var(--card-bg-light);padding:1.5rem;border-radius:.75rem;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:1.5rem;width:100%}h2{font-size:1.25rem;font-weight:700;margin-top:0;margin-bottom:1rem}.tab-buttons{position:fixed;bottom:0;left:0;right:0;background-color:var(--primary-dark-variant);box-shadow:0 -4px 6px rgba(0,0,0,.1);display:flex;justify-content:space-around;padding:.75rem;z-index:10}.tab-buttons button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.5rem 0;border:none;background-color:transparent;color:#fff;font-size:.75rem;border-radius:.5rem;transition:background-color .2s}.tab-buttons button.active{background-color:var(--primary-light-variant)}.tab-buttons button span{font-size:1.5rem;line-height:1}form input,form select,form button{width:100%;padding:.75rem;border-radius:.5rem;border:1px solid var(--border-color-light);font-size:1rem;box-sizing:border-box}form > * {margin-bottom: 0.75rem;}button{background-color:var(--primary-color);color:#fff;font-weight:700;border:none;cursor:pointer;transition:background-color .2s}button:hover{background-color:var(--primary-light-variant)}.split-item-row{display:flex;gap:.5rem;align-items:center}.split-item-row select{flex:2}.split-item-row input{flex:2}.split-item-row button{flex-shrink:0;width:auto;padding:.5rem .75rem;font-size:1rem;line-height:1;background-color:#ef4444}#total-split-amount{font-size:1.25rem;font-weight:700;text-align:right;margin-top:1rem;color:var(--primary-dark-variant)}table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.875rem}th,td{padding:.75rem .5rem;border:1px solid var(--border-color-light);text-align:center}tr.split-group-start > td{border-top:2px solid var(--primary-color) !important}tr.split-child > td{border-top:1px dashed #ccc !important}.split-child .split-info-cell{color:#9ca3af}
    </style>
</head>
<body>
    <header>
        <img src="icon-512.png" alt="かものはし家計簿ロゴ">
        <h1>かものはし家計簿</h1>
    </header>

    <main id="mainContent">
        <div id="homeSection">
             <section>
                <h2>
                    <span style="font-size: 1.5rem; margin-right: 8px;">📷</span>
                    レシート自動入力 (OCR)
                </h2>
                <p style="font-size: 0.8rem; color: #6b7280; margin-top: -8px;">※APIの無料枠（1分あたり60回）を超えないよう、1日の上限を50回に制限しています。</p>
                <input type="file" id="receipt-uploader" accept="image/*" capture="environment">
                <button id="process-receipts-btn" style="margin-top: 0.5rem;">選択したレシートを読み取る</button>
                <div id="ocr-status" style="text-align: center; margin-top: 1rem; font-weight: bold;"></div>
                <div id="ocr-results" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 8px;"></div>
            </section>
            <section>
                <h2>支出・収入の記録</h2>
                <form id="recordForm" class="space-y-3">
                    <div style="display: flex; gap: 1rem;">
                        <input type="date" id="date" required>
                        <select id="type"><option value="expense">支出</option><option value="income">収入</option></select>
                    </div>
                    <input type="text" id="place" placeholder="場所（例：スーパーA）" required>
                    <div id="split-items-container" class="space-y-2 border-t border-b py-4 my-2"></div>
                    <button type="button" id="add-split-item-btn" style="background-color: #e5e7eb; color: #1f2937;">＋ 項目を追加</button>
                    <div id="total-split-amount">合計: ¥0</div>
                    <input type="text" id="tags" placeholder="タグ（グループ全体に適用）">
                    <input type="text" id="memo" placeholder="備考（グループ全体に適用）">
                    <button type="submit">記録</button>
                </form>
            </section>
            <section>
                <h2>履歴</h2>
                <div class="scroll-table"><table><thead><tr><th>日付</th><th>場所</th><th>金額</th><th>ジャンル</th><th>メモ</th><th>タグ</th><th>操作</th></tr></thead><tbody id="historyBody"></tbody></table></div>
            </section>
        </div>
        <div id="settingsSection" style="display:none;">
            <section>
                <h2>ジャンルの管理</h2>
                <div style="display: flex; gap: 8px;"><input type="text" id="newGenre" placeholder="新しいジャンル名"><button id="addGenreBtn" style="width: auto; flex-shrink: 0;">追加</button></div>
                <div id="genreList" style="margin-top: 1rem;"></div>
            </section>
            <section>
                <h2>Gemini API キー設定</h2>
                <input type="password" id="apiKeyInput" placeholder="ここにGemini APIキーを貼り付け">
                <button id="saveApiKeyBtn" style="margin-top: 0.5rem;">APIキーを保存</button>
                <p style="font-size: 0.8rem; color: #6b7280; margin-top: 8px;">※APIキーはあなたのブラウザ内にのみ安全に保存されます。</p>
            </section>
        </div>
    </main>
    <div class="tab-buttons">
        <button id="homeTab" class="active"><span>🏠</span>ホーム</button>
        <button id="settingsTab"><span>⚙️</span>設定</button>
    </div>

    <script type="module">
        // --- グローバル変数 ---
        let transactions = [];
        let genres = ['食費', '日用品', '交通費', '娯楽費', '外食', '光熱費', '通信費', '家賃', '給与', 'その他収入'];
        const LOCAL_STORAGE_KEY = 'kakeiboData';

        // --- データ管理 ---
        function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }

        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!storedData) return;
            const data = JSON.parse(storedData);
            transactions = data.transactions || [];
            genres = data.genres || ['食費', '日用品', '交通費', '娯楽費', '外食', '光熱費', '通信費', '家賃', '給与', 'その他収入'];
        }

        function saveData() {
            const dataToSave = { transactions, genres };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
        }

        // --- UI更新 ---
        function renderApp() {
            updateHistoryTable();
            updateGenreManagementList();
            updateSplitItemGenreSelects();
        }
        
        function switchTab(tabName) {
            document.getElementById('homeSection').style.display = (tabName === 'home' ? 'block' : 'none');
            document.getElementById('settingsSection').style.display = (tabName === 'settings' ? 'block' : 'none');
            document.getElementById('homeTab').classList.toggle('active', tabName === 'home');
            document.getElementById('settingsTab').classList.toggle('active', tabName === 'settings');
        }
        
        function updateGenreManagementList() {
            const genreListDiv = document.getElementById('genreList');
            genreListDiv.innerHTML = '';
            genres.forEach(g => {
                const itemDiv = document.createElement('div');
                itemDiv.style.display = 'flex';
                itemDiv.style.justifyContent = 'space-between';
                itemDiv.innerHTML = `<span>${g}</span><button class="delete-btn" data-genre="${g}" style="width:auto;padding:2px 6px;margin-left:8px;">&times;</button>`;
                genreListDiv.appendChild(itemDiv);
                itemDiv.querySelector('.delete-btn').addEventListener('click', e => deleteGenre(e.target.dataset.genre));
            });
        }
        
        function updateHistoryTable() {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '';
            const sortedTransactions = [...transactions].sort((a,b) => (b.date > a.date) ? 1 : ((a.date > b.date) ? -1 : 0));
            sortedTransactions.forEach((transaction, index) => {
                const row = historyBody.insertRow();
                let isSplitChild = transaction.splitGroupId && index > 0 && sortedTransactions[index - 1].splitGroupId === transaction.splitGroupId;
                if (transaction.splitGroupId && !isSplitChild) row.classList.add('split-group-start');
                if (isSplitChild) row.classList.add('split-child');
                const infoCell = (content) => isSplitChild ? `<span class="split-info-cell">${content || ''}</span>` : `<span>${content || ''}</span>`;
                row.innerHTML = `<td>${infoCell(transaction.date)}</td><td>${infoCell(transaction.place)}</td><td style="color: ${transaction.type === 'expense' ? 'red' : 'green'};">${new Intl.NumberFormat().format(transaction.amount)}円</td><td>${transaction.genre}</td><td>${infoCell(transaction.memo)}</td><td>${infoCell(transaction.tags)}</td><td><button class="delete-btn" data-timestamp="${transaction.timestamp}">削除</button></td>`;
                row.querySelector('.delete-btn').addEventListener('click', (e) => deleteTransaction(e.target.dataset.timestamp));
            });
        }

        // --- 分割機能 ---
        function addSplitItemRow(container) {
            const row = document.createElement('div');
            row.className = 'split-item-row';
            const genreSelect = document.createElement('select');
            genreSelect.className = 'split-genre';
            updateGenreOptions(genreSelect);
            const amountInput = document.createElement('input');
            amountInput.type = 'number'; amountInput.className = 'split-amount';
            amountInput.placeholder = '金額'; amountInput.min = '0';
            amountInput.addEventListener('input', updateSplitTotal);
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button'; deleteBtn.textContent = '✖';
            deleteBtn.addEventListener('click', () => {
                if (container.querySelectorAll('.split-item-row').length > 1) { row.remove(); updateSplitTotal(); }
            });
            row.appendChild(genreSelect); row.appendChild(amountInput); row.appendChild(deleteBtn);
            container.appendChild(row);
        }

        function updateGenreOptions(selectElement) {
            selectElement.innerHTML = '';
            genres.filter(g => !['給与', 'その他収入'].includes(g)).forEach(g => {
                const option = document.createElement('option');
                option.value = g; option.textContent = g;
                selectElement.appendChild(option);
            });
        }

        function updateSplitItemGenreSelects() {
            document.querySelectorAll('.split-genre').forEach(updateGenreOptions);
        }

        function updateSplitTotal() {
            const container = document.getElementById('split-items-container');
            const amounts = Array.from(container.querySelectorAll('.split-amount'));
            const total = amounts.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            document.getElementById('total-split-amount').textContent = `合計: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(total)}`;
        }
        
        // --- イベントハンドラ ---
        function handleRecordSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('date').value;
            const place = document.getElementById('place').value;
            const type = document.getElementById('type').value;
            const memo = document.getElementById('memo').value;
            const tags = document.getElementById('tags').value;
            const splitItems = document.querySelectorAll('.split-item-row');
            if (!place) { alert('場所を入力してください。'); return; }
            const splitGroupId = generateUniqueId();
            let recordsToAdd = [];
            splitItems.forEach(item => {
                const genre = item.querySelector('.split-genre').value;
                const amount = parseInt(item.querySelector('.split-amount').value);
                if (genre && amount > 0) {
                    recordsToAdd.push({ date, place, type, memo, tags, genre, amount, splitGroupId, timestamp: generateUniqueId() });
                }
            });
            if (recordsToAdd.length > 0) {
                transactions.push(...recordsToAdd);
                saveData();
                renderApp();
                document.getElementById('recordForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                const container = document.getElementById('split-items-container');
                container.innerHTML = ''; addSplitItemRow(container); updateSplitTotal();
            } else {
                alert('有効な金額を持つ項目がありません。');
            }
        }
        
        function deleteTransaction(timestamp) {
            const txToDelete = transactions.find(t => t.timestamp === timestamp);
            if (!txToDelete) return;
            let msg = 'この記録を削除しますか？';
            if (txToDelete.splitGroupId && transactions.filter(t => t.splitGroupId === txToDelete.splitGroupId).length > 1) {
                msg = 'これは分割記録の一部です。この項目のみ削除しますか？';
            }
            if (window.confirm(msg)) {
                transactions = transactions.filter(t => t.timestamp !== timestamp);
                saveData();
                renderApp();
            }
        }

        function addGenre() {
            const newGenreInput = document.getElementById('newGenre');
            const newGenreName = newGenreInput.value.trim();
            if (newGenreName && !genres.includes(newGenreName)) {
                genres.push(newGenreName);
                genres.sort();
                saveData();
                renderApp();
                newGenreInput.value = '';
            }
        }

        function deleteGenre(genreName) {
            if (window.confirm(`「${genreName}」を削除しますか？`)) {
                genres = genres.filter(g => g !== genreName);
                saveData();
                renderApp();
            }
        }

        // --- OCR機能 ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function handleReceiptProcessing() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                alert('APIキーが設定されていません。「設定」画面でAPIキーを保存してください。');
                switchTab('settings');
                return;
            }
            const uploader = document.getElementById('receipt-uploader');
            const statusDiv = document.getElementById('ocr-status');
            const resultsDiv = document.getElementById('ocr-results');
            const files = uploader.files;
            if (files.length === 0) { alert('レシート画像を選択してください。'); return; }

            statusDiv.textContent = '処理を開始します...'; resultsDiv.innerHTML = '';
            const SAFE_LIMIT_PER_DAY = 50;
            const today = new Date().toISOString().slice(0, 10);
            let usageCount = parseInt(localStorage.getItem(`ocrUsage_${today}`) || '0');

            if (usageCount >= SAFE_LIMIT_PER_DAY) {
                statusDiv.textContent = `1日の上限（${SAFE_LIMIT_PER_DAY}回）に達しました。`;
                return;
            }

            const genAI = new window.GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (usageCount >= SAFE_LIMIT_PER_DAY) {
                    statusDiv.textContent = `1日の上限に達したため処理を中断しました。`;
                    break;
                }
                statusDiv.textContent = `(${i + 1}/${files.length}) ${file.name} を読み取り中...`;
                try {
                    const base64Image = await fileToBase64(file);
                    const prompt = `このレシート画像から以下の情報を抽出し、必ずJSON形式で回答してください。- place: 店名 (文字列) - date: 日付 (YYYY-MM-DD形式の文字列) - total: 合計金額 (数値) 情報が読み取れない場合は、該当する値に "不明" または 0 を入れてください。`;
                    const imagePart = { inlineData: { data: base64Image, mimeType: file.type } };
                    const result = await model.generateContent([prompt, imagePart]);
                    const responseText = result.response.text().replace(/```json|```/g, '').trim();
                    const data = JSON.parse(responseText);

                    const card = document.createElement('div');
                    card.style.border = '1px solid #ccc'; card.style.padding = '12px'; card.style.cursor = 'pointer';
                    card.innerHTML = `<strong>店名:</strong> ${data.place || '不明'}<br><strong>日付:</strong> ${data.date || '不明'}<br><strong>合計:</strong> ${new Intl.NumberFormat().format(data.total || 0)} 円`;
                    card.onclick = () => {
                        document.getElementById('place').value = data.place || '';
                        if(data.date && data.date !== '不明') document.getElementById('date').value = data.date;
                        const container = document.getElementById('split-items-container');
                        container.innerHTML = ''; addSplitItemRow(container);
                        container.querySelector('.split-amount').value = data.total || '';
                        updateSplitTotal();
                        alert(`「${data.place}」の情報をフォームに入力しました。`);
                    };
                    resultsDiv.appendChild(card);
                    usageCount++;
                    localStorage.setItem(`ocrUsage_${today}`, usageCount);
                } catch (err) {
                    console.error("OCR処理エラー:", err);
                    const errorCard = document.createElement('div');
                    errorCard.style.color = 'red'; errorCard.textContent = `${file.name} - 読み取り失敗`;
                    resultsDiv.appendChild(errorCard);
                }
            }
            statusDiv.textContent = '全ての処理が完了しました。';
            uploader.value = ''; // 選択をリセット
        }

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('homeTab').addEventListener('click', () => switchTab('home'));
            document.getElementById('settingsTab').addEventListener('click', () => switchTab('settings'));
            document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
            document.getElementById('add-split-item-btn').addEventListener('click', () => addSplitItemRow(document.getElementById('split-items-container')));
            document.getElementById('addGenreBtn').addEventListener('click', addGenre);
            
            const apiKeyInput = document.getElementById('apiKeyInput');
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
            if (apiKeyInput) apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            if (saveApiKeyBtn) saveApiKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) { localStorage.setItem('geminiApiKey', key); alert('APIキーを保存しました。'); } 
                else { alert('APIキーを入力してください。'); }
            });
            document.getElementById('process-receipts-btn').addEventListener('click', handleReceiptProcessing);
            
            const container = document.getElementById('split-items-container');
            addSplitItemRow(container);
            updateSplitTotal();
            document.getElementById('date').valueAsDate = new Date();
            
            switchTab('home');
            renderApp();
        });
    </script>
</body>
</html>