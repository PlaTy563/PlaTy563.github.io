<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‹ã‚‚ã®ã¯ã—å®¶è¨ˆç°¿</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        :root{--primary-color:#2e7d32;--primary-dark-variant:#266b2a;--primary-light-variant:#5cb85c;--background-light:#f8f8f8;--card-bg-light:#fff;--text-color-light:#333;--border-color-light:#e0e0e0}
        *,*::before,*::after{box-sizing:border-box}
        body{margin:0;font-family:'Noto Sans JP',sans-serif;padding-bottom:90px;background-color:var(--background-light);color:var(--text-color-light)}
        @media (prefers-color-scheme:dark){:root{--background-light:#121212;--card-bg-light:#1e1e1e;--text-color-light:#e0e0e0;--border-color-light:#444}}
        header{display:flex;align-items:center;padding:1rem;background-color:var(--primary-dark-variant);color:#fff;width:100%;max-width:48rem;margin:0 auto;box-shadow:0 4px 6px rgba(0,0,0,.1);border-bottom-left-radius:.75rem;border-bottom-right-radius:.75rem}
        header img{width:64px;height:64px;margin-right:1rem}
        header h1{font-size:1.75rem;font-weight:700;margin:0}
        main{display:flex;flex-direction:column;align-items:center;width:100%;max-width:48rem;margin:2rem auto;padding:0 1rem}
        section{background-color:var(--card-bg-light);padding:1.5rem;border-radius:.75rem;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:1.5rem;width:100%}
        h2{font-size:1.25rem;font-weight:700;margin-top:0;margin-bottom:1rem}
        .tab-buttons{position:fixed;bottom:0;left:0;right:0;background-color:var(--primary-dark-variant);box-shadow:0 -4px 6px rgba(0,0,0,.1);display:flex;justify-content:space-around;padding:.75rem;z-index:10}
        .tab-buttons button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.5rem 0;border:none;background-color:transparent;color:#fff;font-size:.75rem;border-radius:.5rem;transition:background-color .2s}
        .tab-buttons button.active{background-color:var(--primary-light-variant)}
        .tab-buttons button span{font-size:1.5rem;line-height:1}
        form input,form select,form button{width:100%;padding:.75rem;border-radius:.5rem;border:1px solid var(--border-color-light);font-size:1rem;margin-bottom:.75rem}
        button{background-color:var(--primary-color);color:#fff;font-weight:700;border:none;cursor:pointer;transition:background-color .2s;border-radius:.5rem;padding:.75rem 1rem}
        button:hover{background-color:var(--primary-light-variant)}
        .split-item-row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}.split-item-row select,.split-item-row input{flex:1}
        .split-item-row button{flex-shrink:0;width:auto;padding:.5rem .75rem;font-size:1rem;line-height:1;background-color:#ef4444}
        #total-split-amount{font-size:1.25rem;font-weight:700;text-align:right;margin-top:1rem;color:var(--primary-dark-variant)}
        table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.875rem}th,td{padding:.75rem .5rem;border:1px solid var(--border-color-light);text-align:center}
        tr.split-group-start > td{border-top:2px solid var(--primary-color) !important}
        tr.split-child > td{border-top:1px dashed #ccc !important}
        .split-child .split-info-cell{color:#9ca3af}
        .calendar-grid-container{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center}.calendar-day-header{font-weight:700;font-size:.8rem;padding-bottom:4px}.calendar-day-cell{border:1px solid var(--border-color-light);border-radius:.5rem;padding:4px;min-height:60px;display:flex;flex-direction:column;align-items:center;font-size:.8rem}.calendar-expense-amount{font-size:.7rem;color:red;font-weight:700;margin-top:4px}
        .scroll-table{overflow-x:auto}
        button, input, select { min-height: 48px; font-size: 1.1rem; }
        .tab-buttons button { min-height: 48px; font-size: 1rem; }
        input[type="date"], input[type="number"], input[type="text"], select { font-size: 1.1rem; padding: 0.75rem 0.5rem; }
        @media (max-width: 600px) {
            main, section { padding: 0.5rem; }
            h1, h2 { font-size: 1.1rem; }
            table th, table td { font-size: 0.95rem; padding: 0.5rem 0.25rem; }
        }
    </style>
</head>
<body>
    <header>
        <img src="icon-512.png" alt="ã‹ã‚‚ã®ã¯ã—å®¶è¨ˆç°¿ãƒ­ã‚´">
        <h1>ã‹ã‚‚ã®ã¯ã—å®¶è¨ˆç°¿</h1>
    </header>
    <main id="mainContent">
        <div id="homeSection">
             <section>
                <h2><span style="font-size:1.5rem;margin-right:8px;">ğŸ“·</span>ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•å…¥åŠ› (OCR)</h2>
                <input type="file" id="receipt-uploader" accept="image/*" capture="environment">
                <button id="process-receipts-btn" style="margin-top:0.5rem;">é¸æŠã—ãŸãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿å–ã‚‹</button>
                <div id="ocr-status" style="text-align:center;margin-top:1rem;font-weight:bold;"></div>
                <div id="ocr-results" style="margin-top:1rem;display:flex;flex-direction:column;gap:8px;"></div>
            </section>
            <section>
                <h2>æ”¯å‡ºãƒ»åå…¥ã®è¨˜éŒ²</h2>
                <form id="recordForm">
                    <div style="display:flex;gap:1rem;"><input type="date" id="date" required><select id="type"><option value="expense">æ”¯å‡º</option><option value="income">åå…¥</option></select></div>
                    <input type="text" id="place" placeholder="å ´æ‰€ï¼ˆä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼Aï¼‰" required>
                    <div id="split-items-container" class="space-y-2 border-t border-b py-4 my-2"></div>
                    <button type="button" id="add-split-item-btn" style="background-color:#e5e7eb;color:#1f2937;">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>
                    <div id="total-split-amount">åˆè¨ˆ: Â¥0</div>
                    <input type="text" id="tags" placeholder="ã‚¿ã‚°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã«é©ç”¨ï¼‰">
                    <input type="text" id="memo" placeholder="å‚™è€ƒï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã«é©ç”¨ï¼‰">
                    <button type="submit">è¨˜éŒ²</button>
                </form>
            </section>
            <section>
                <h2>
                    <input type="month" id="monthSelector" style="font-size:1.25rem;border:none;padding-left:0;width:auto;">ã®çŠ¶æ³
                </h2>
                <div id="budgetTableArea" style="margin-bottom:1rem;"></div>
                 <div id="budgetProgressBars" style="margin-top:1.5rem;"></div>
                <div class="calendar-grid-container" style="margin-top:1.5rem;"></div>
            </section>
            <section>
                <h2>å±¥æ­´</h2>
                 <button id="monthlyReportBtn" style="margin-bottom:1rem;">ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹</button>
                <div id="monthlyReportArea" style="margin-top:1rem; margin-bottom:1rem;"></div>
                <div class="scroll-table"><table><thead><tr><th>æ—¥ä»˜</th><th>å ´æ‰€</th><th>é‡‘é¡</th><th>ã‚¸ãƒ£ãƒ³ãƒ«</th><th>ãƒ¡ãƒ¢</th><th>ã‚¿ã‚°</th><th>æ“ä½œ</th></tr></thead><tbody id="historyBody"></tbody></table></div>
            </section>
            <section>
              <h2>å£åº§æ®‹é«˜</h2>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" id="accountBalanceInput" placeholder="ç¾åœ¨ã®å£åº§æ®‹é«˜" style="flex:1;">
                <button id="saveAccountBalanceBtn" style="width:auto;">ä¿å­˜</button>
              </div>
              <div id="balanceGraphArea" style="margin:1rem 0;"></div>
            </section>
        </div>
        <div id="settingsSection" style="display:none;">
            <section>
                <h2>Google Drive ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
                <div id="auth-status" style="margin-bottom:1rem;font-weight:bold;">åˆæœŸåŒ–ä¸­...</div>
                <div style="display:flex;gap:8px;">
                    <button id="authorize_button" style="background-color:#4285F4;visibility:hidden;">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                    <button id="signout_button" style="display:none;background-color:#db4437;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button id="backup_button" disabled>Driveã¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                    <button id="restore_button" disabled>Driveã‹ã‚‰å¾©å…ƒ</button>
                </div>
                <div id="backup-status" style="text-align:center;margin-top:1rem;"></div>
            </section>
            <section>
                <h2>ã‚¸ãƒ£ãƒ³ãƒ«ã®ç®¡ç†</h2>
                <div style="display:flex;gap:8px;">
                  <input type="text" id="newGenre" placeholder="æ–°ã—ã„ã‚¸ãƒ£ãƒ³ãƒ«å">
                  <select id="newGenreType">
                    <option value="">é€šå¸¸</option>
                    <option value="fixed">å®šæœŸï¼ˆå›ºå®šï¼‰</option>
                    <option value="variable">å®šæœŸï¼ˆå¤‰å‹•ï¼‰</option>
                  </select>
                  <button id="addGenreBtn" style="width:auto;flex-shrink:0;">è¿½åŠ </button>
                </div>
                <div id="genreList" style="margin-top:1rem;"></div>
            </section>
            <section>
                <h2>äºˆç®—ã®è¨­å®š</h2>
                <div style="display:flex;gap:8px;"><select id="budgetGenre" style="flex:1;"></select><input type="number" id="budgetAmount" placeholder="é‡‘é¡" style="flex:1;"><button id="setBudgetBtn" style="width:auto;flex-shrink:0;">è¨­å®š</button></div>
                <button id="copyBudgetBtn" style="width:100%;margin-top:8px;">å…ˆæœˆã®äºˆç®—ã‚’ã‚³ãƒ”ãƒ¼</button>
            </section>
            <section>
                <h2>Gemini API ã‚­ãƒ¼è¨­å®š</h2>
                <input type="password" id="apiKeyInput" placeholder="ã“ã“ã«Gemini APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘">
                <button id="saveApiKeyBtn" style="margin-top:0.5rem;">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
            </section>
            <section>
                <h2>ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                <button id="exportDataBtn">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <input type="file" id="importFileInput" style="display:none;" accept=".json">
                <button id="importDataButton" style="margin-top:8px;">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </section>
            <section>
                <h2>å¤‰å‹•æ”¯å‡ºç¢ºèªæ—¥</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="number" id="variableExpenseCheckDay" min="1" max="31" placeholder="æ¯æœˆä½•æ—¥ç›®ã«ç¢ºèª" style="flex:1;">
                    <button id="saveVariableExpenseCheckDayBtn" style="width:auto;">ä¿å­˜</button>
                </div>
                <div id="variableExpenseCheckDayStatus" style="margin-top:0.5rem;color:#666;font-size:0.95rem;"></div>
            </section>
        </div>
    </main>
    <div class="tab-buttons">
        <button id="homeTab" class="active"><span>ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
        <button id="settingsTab"><span>âš™ï¸</span>è¨­å®š</button>
    </div>

    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let transactions = [];
        let genres = [
          { name: 'é£Ÿè²»', type: '' },
          { name: 'å®¶è³ƒ', type: 'fixed' },
          { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰', type: 'variable' },
        ];
        let budgetsByMonth = {};
        let rolloverGenres = [];
        let currentMonth = new Date().toISOString().slice(0, 7);
        let budgetPieChart = null;
        let accountBalance = 0;
        let variableExpenseCheckDay = 1;
        const LOCAL_STORAGE_KEY = 'kakeiboData';

        // --- Google Drive APIé–¢é€£ ---
        const API_KEY = 'AIzaSyA8SHDfUl1CWayCmq6oGREjnxWR6R8vPkM'; // â˜…GitHubã«ä¸Šã’ã‚‹éš›ã¯å¿…ãšãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«æˆ»ã™ã“ã¨ï¼
        const CLIENT_ID = '98738563895-d80ev131bgogmct7hi0qv3ojopu52dsj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const BACKUP_FILENAME = 'kakeibo_backup.json';
        let tokenClient, gapiInited = false, gsiInited = false, backupFileId = null;

        // --- Google APIåˆæœŸåŒ–ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ ---
        window.gapiLoaded = () => gapi.load('client', initializeGapiClient);
        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gsiInited = true;
            maybeInitAuth();
        };

        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            maybeInitAuth();
        }

        function maybeInitAuth() {
            const authStatus = document.getElementById('auth-status');
            if (gapiInited && gsiInited) {
                authStatus.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                document.getElementById('authorize_button').style.visibility = 'visible';
                if (localStorage.getItem('google_auth_loggedin') === 'true') {
                   handleAuthClick(true);
                }
            }
        }

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }

        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!storedData) return;
            const data = JSON.parse(storedData);
            transactions = data.transactions || [];
            genres = data.genres || [ { name: 'é£Ÿè²»', type: '' }, { name: 'å®¶è³ƒ', type: 'fixed' }, { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰', type: 'variable' } ];
            budgetsByMonth = data.budgetsByMonth || data.budgets || {};
            rolloverGenres = data.rolloverGenres || [];
            accountBalance = parseInt(localStorage.getItem('accountBalance') || '0');
            variableExpenseCheckDay = parseInt(localStorage.getItem('variableExpenseCheckDay') || '1');
        }

        function saveData() {
            const dataToSave = { transactions, genres, budgetsByMonth, rolloverGenres };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            localStorage.setItem('accountBalance', accountBalance);
            localStorage.setItem('variableExpenseCheckDay', variableExpenseCheckDay);
        }

        // --- UIæ›´æ–° ---
        function renderApp() {
            document.getElementById('monthSelector').value = currentMonth;
            document.getElementById('accountBalanceInput').value = accountBalance || '';
            document.getElementById('variableExpenseCheckDay').value = variableExpenseCheckDay || '';
            document.getElementById('variableExpenseCheckDayStatus').textContent = `ç¾åœ¨ã®ç¢ºèªæ—¥ã¯æ¯æœˆ${variableExpenseCheckDay}æ—¥ã§ã™ã€‚`;

            updateHistoryTable();
            updateGenreManagementList();
            updateBudgetGenreSelector();
            updateSplitItemGenreSelects();
            updateCalendarView();
            updateBudgetTable();
            updateBudgetProgressBars();
            renderBalanceGraph();
            checkVariableExpensesIfNeeded();
        }

        function switchTab(tabName) {
            document.getElementById('homeSection').style.display = (tabName === 'home' ? 'block' : 'none');
            document.getElementById('settingsSection').style.display = (tabName === 'settings' ? 'block' : 'none');
            document.getElementById('homeTab').classList.toggle('active', tabName === 'home');
            document.getElementById('settingsTab').classList.toggle('active', tabName === 'settings');
        }

        function updateGenreManagementList() {
            const genreListDiv = document.getElementById('genreList');
            genreListDiv.innerHTML = '';
            genres.forEach(g => {
                const isRolloverEnabled = rolloverGenres.includes(g.name);
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:4px;border-bottom:1px solid var(--border-color-light)';
                itemDiv.innerHTML = `<span>${g.name} (${g.type || 'é€šå¸¸'})</span><div style="display:flex;align-items:center;gap:8px;"><label style="font-size:0.8rem;"><input type="checkbox" class="rollover-checkbox" data-genre="${g.name}" ${isRolloverEnabled ? 'checked' : ''}> ç¹°è¶Š</label><button class="delete-btn" data-genre="${g.name}" style="width:auto;padding:2px 6px;background-color:#ef4444;">&times;</button></div>`;
                genreListDiv.appendChild(itemDiv);
                itemDiv.querySelector('.delete-btn').addEventListener('click', e => deleteGenre(e.target.dataset.genre));
                itemDiv.querySelector('.rollover-checkbox').addEventListener('change', e => handleRolloverChange(e.target.dataset.genre, e.target.checked));
            });
        }

        function updateHistoryTable() {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '';
            const filtered = transactions.filter(t => t.date && t.date.startsWith(currentMonth));
            const sorted = filtered.sort((a,b) => b.date.localeCompare(a.date) || (b.timestamp > a.timestamp ? -1 : 1));
            sorted.forEach((transaction, index) => {
                const row = historyBody.insertRow();
                let isSplitChild = transaction.splitGroupId && index > 0 && sorted[index - 1].splitGroupId === transaction.splitGroupId;
                if (transaction.splitGroupId && !isSplitChild) row.classList.add('split-group-start');
                if (isSplitChild) row.classList.add('split-child');
                const infoCell = (content) => isSplitChild ? `<span class="split-info-cell">${content || ''}</span>` : `<span>${content || ''}</span>`;
                row.innerHTML = `<td>${infoCell(transaction.date)}</td><td>${infoCell(transaction.place)}</td><td style="color:${transaction.type === 'expense'?'red':'green'};">${new Intl.NumberFormat().format(transaction.amount)}å††</td><td>${transaction.genre}</td><td>${infoCell(transaction.memo)}</td><td>${infoCell(transaction.tags)}</td><td><button class="delete-btn" data-timestamp="${transaction.timestamp}" style="background-color:#ef4444;padding:4px 8px;width:auto;">å‰Šé™¤</button></td>`;
                row.querySelector('.delete-btn').addEventListener('click', (e) => deleteTransaction(e.target.dataset.timestamp));
            });
        }

        function updateCalendarView() {
            const calendarContainer = document.querySelector('.calendar-grid-container');
            calendarContainer.innerHTML = '';
            const dayHeaders = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            dayHeaders.forEach(day => calendarContainer.insertAdjacentHTML('beforeend', `<div class="calendar-day-header">${day}</div>`));
            const [year, month] = currentMonth.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyTotals = {};
            transactions.filter(t => t.date && t.date.startsWith(currentMonth) && t.type === 'expense').forEach(t => {
                const day = new Date(t.date).getDate();
                dailyTotals[day] = (dailyTotals[day] || 0) + t.amount;
            });
            for (let i = 0; i < firstDay; i++) calendarContainer.insertAdjacentHTML('beforeend', '<div></div>');
            for (let day = 1; day <= daysInMonth; day++) {
                let content = `<span class="calendar-day-number">${day}</span>`;
                if (dailyTotals[day]) content += `<span class="calendar-expense-amount">${new Intl.NumberFormat().format(dailyTotals[day])}å††</span>`;
                calendarContainer.insertAdjacentHTML('beforeend', `<div class="calendar-day-cell">${content}</div>`);
            }
        }

        function updateBudgetTable() {
            const area = document.getElementById('budgetTableArea');
            const monthlyBudget = budgetsByMonth[currentMonth] || {};
            let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr><th>ã‚¸ãƒ£ãƒ³ãƒ«</th><th>äºˆç®—</th><th>æ”¯å‡º</th><th>æ®‹é¡</th></tr></thead><tbody>';
            Object.keys(monthlyBudget).forEach(genre => {
                const budget = monthlyBudget[genre];
                const spent = transactions
                    .filter(t => t.date && t.date.startsWith(currentMonth) && t.genre === genre && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                html += `<tr><td>${genre}</td><td>${new Intl.NumberFormat().format(budget)}å††</td><td style="color:${spent>budget?'red':'black'};">${new Intl.NumberFormat().format(spent)}å††</td><td>${new Intl.NumberFormat().format(budget-spent)}å††</td></tr>`;
            });
            html += '</tbody></table>';
            area.innerHTML = html;
        }

        function updateBudgetProgressBars(){} // å®Ÿè£…ã¯çœç•¥

        function addSplitItemRow(container) {
            const row = document.createElement('div');
            row.className = 'split-item-row';
            const genreSelect = document.createElement('select');
            genreSelect.className = 'split-genre';
            updateGenreOptions(genreSelect);
            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.className = 'split-amount';
            amountInput.placeholder = 'é‡‘é¡';
            amountInput.min = '0';
            amountInput.addEventListener('input', updateSplitTotal);
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'âœ–';
            deleteBtn.addEventListener('click', () => { if (container.querySelectorAll('.split-item-row').length > 1) { row.remove(); updateSplitTotal(); }});
            row.appendChild(genreSelect);
            row.appendChild(amountInput);
            row.appendChild(deleteBtn);
            container.appendChild(row);
        }

        function updateGenreOptions(selectElement) {
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            genres.filter(g => !['çµ¦ä¸', 'ãã®ä»–åå…¥'].includes(g.name)).forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                selectElement.appendChild(option);
            });
            if(currentVal) selectElement.value = currentVal;
        }

        function updateSplitItemGenreSelects() { document.querySelectorAll('.split-genre').forEach(updateGenreOptions); }

        function updateSplitTotal() {
            const container = document.getElementById('split-items-container');
            const amounts = Array.from(container.querySelectorAll('.split-amount'));
            const total = amounts.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            document.getElementById('total-split-amount').textContent = `åˆè¨ˆ: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(total)}`;
        }

        function handleRecordSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('date').value,
                place = document.getElementById('place').value,
                type = document.getElementById('type').value,
                memo = document.getElementById('memo').value,
                tags = document.getElementById('tags').value,
                splitItems = document.querySelectorAll('.split-item-row');
            if (!place) { alert('å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            const splitGroupId = generateUniqueId();
            let recordsToAdd = [];
            splitItems.forEach(item => {
                const genre = item.querySelector('.split-genre').value;
                const amount = parseInt(item.querySelector('.split-amount').value);
                if (genre && amount > 0) {
                    recordsToAdd.push({ date, place, type, memo, tags, genre, amount, splitGroupId, timestamp: generateUniqueId() });
                }
            });
            if (recordsToAdd.length > 0) {
                transactions.push(...recordsToAdd);
                saveData();
                renderApp();
                document.getElementById('recordForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                const container = document.getElementById('split-items-container');
                container.innerHTML = '';
                addSplitItemRow(container);
                updateSplitTotal();
            } else {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’æŒã¤é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        }

        function deleteTransaction(timestamp) {
            const txToDelete = transactions.find(t => t.timestamp === timestamp);
            if (!txToDelete) return;
            let msg = 'ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ';
            if (txToDelete.splitGroupId && transactions.filter(t => t.splitGroupId === txToDelete.splitGroupId).length > 1) {
                msg = 'ã“ã‚Œã¯åˆ†å‰²è¨˜éŒ²ã®ä¸€éƒ¨ã§ã™ã€‚ã“ã®é …ç›®ã®ã¿å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ';
            }
            if (window.confirm(msg)) {
                transactions = transactions.filter(t => t.timestamp !== timestamp);
                saveData();
                renderApp();
            }
        }

        function addGenre() {
            const newGenreInput = document.getElementById('newGenre');
            const newGenreType = document.getElementById('newGenreType').value;
            const newGenreName = newGenreInput.value.trim();
            if (newGenreName && !genres.some(g => g.name === newGenreName)) {
                genres.push({ name: newGenreName, type: newGenreType });
                saveData();
                renderApp();
                newGenreInput.value = '';
            }
        }

        function deleteGenre(genreName) {
            if (window.confirm(`ã€Œ${genreName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                genres = genres.filter(g => g.name !== genreName);
                rolloverGenres = rolloverGenres.filter(g => g !== genreName);
                saveData();
                renderApp();
            }
        }

        function updateBudgetGenreSelector() {
            const budgetGenreSelect = document.getElementById('budgetGenre');
            if(!budgetGenreSelect) return;
            budgetGenreSelect.innerHTML = '';
            genres.forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                budgetGenreSelect.appendChild(option);
            });
        }

        function setBudget() {
             const genre = document.getElementById('budgetGenre').value;
             const amount = parseInt(document.getElementById('budgetAmount').value);
             if (genre && !isNaN(amount)) {
                if(!budgetsByMonth[currentMonth]) budgetsByMonth[currentMonth] = {};
                budgetsByMonth[currentMonth][genre] = amount;
                saveData();
                renderApp();
             }
        }

        function copyLastMonthBudget() {
            const date = new Date(currentMonth + '-01');
            date.setMonth(date.getMonth() - 1);
            const lastMonthKey = date.toISOString().slice(0, 7);
            if (budgetsByMonth[lastMonthKey]) {
                budgetsByMonth[currentMonth] = { ...budgetsByMonth[lastMonthKey] };
                saveData();
                renderApp();
                alert(`${lastMonthKey}ã®äºˆç®—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚`);
            } else {
                alert('å‰æœˆã®äºˆç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        }

        function handleRolloverChange(genre, isChecked) {
            const index = rolloverGenres.indexOf(genre);
            if (isChecked && index === -1) rolloverGenres.push(genre);
            else if (!isChecked && index > -1) rolloverGenres.splice(index, 1);
            saveData();
        }

        function exportData() {
            const dataStr = JSON.stringify({ transactions, genres, budgetsByMonth, rolloverGenres }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kakeibo_data_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                        transactions = data.transactions || [];
                        genres = data.genres || [];
                        budgetsByMonth = data.budgetsByMonth || {};
                        rolloverGenres = data.rolloverGenres || [];
                        saveData();
                        renderApp();
                    }
                } catch (err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            };
            reader.readAsText(file);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function handleReceiptProcessing() {
            const uploader = document.getElementById('receipt-uploader');
            const statusDiv = document.getElementById('ocr-status');
            const resultsDiv = document.getElementById('ocr-results');
            const processBtn = document.getElementById('process-receipts-btn');

            processBtn.disabled = true;
            processBtn.textContent = 'èª­ã¿å–ã‚Šä¸­...';

            try {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œè¨­å®šã€ç”»é¢ã§APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                    switchTab('settings');
                    return;
                }

                const files = uploader.files;
                if (files.length === 0) {
                    alert('ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (files.length > 1) {
                    alert('è¤‡æ•°ãƒ¬ã‚·ãƒ¼ãƒˆã®ä¸€æ‹¬èª­ã¿å–ã‚Šã§ã¯ã€ä¸€åº¦ã«1æšã®ç”»åƒã®ã¿é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                statusDiv.textContent = 'å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...';
                resultsDiv.innerHTML = '';
                const SAFE_LIMIT_PER_DAY = 50;
                const today = new Date().toISOString().slice(0, 10);
                let usageCount = parseInt(localStorage.getItem(`ocrUsage_${today}`) || '0');

                if (usageCount >= SAFE_LIMIT_PER_DAY) {
                    statusDiv.textContent = `1æ—¥ã®ä¸Šé™ï¼ˆ${SAFE_LIMIT_PER_DAY}å›ï¼‰ã«é”ã—ã¾ã—ãŸã€‚`;
                    return;
                }

                const file = files[0];
                statusDiv.textContent = `${file.name} ã‚’èª­ã¿å–ã‚Šä¸­...`;

                const genAI = new window.GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const base64Image = await fileToBase64(file);
                const prompt = `ã“ã®1æšã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹å…¨ã¦ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å€‹åˆ¥ã«èªè­˜ã—ã€å„ãƒ¬ã‚·ãƒ¼ãƒˆã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã€å¿…ãšJSONã®é…åˆ—ï¼ˆãƒªã‚¹ãƒˆï¼‰å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚- place: åº—å (æ–‡å­—åˆ—) - date: æ—¥ä»˜ (YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—) - total: åˆè¨ˆé‡‘é¡ (æ•°å€¤)`;
                const imagePart = { inlineData: { data: base64Image, mimeType: file.type } };
                const result = await model.generateContent([prompt, imagePart]);
                const responseText = result.response.text().replace(/```json|```/g, '').trim();
                const resultsArray = JSON.parse(responseText);

                if (resultsArray.length === 0) {
                    statusDiv.textContent = 'ç”»åƒã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                    return;
                }

                resultsArray.forEach(data => {
                    const card = document.createElement('div');
                    card.style.cssText = 'border: 1px solid #ccc; padding: 12px; cursor: pointer; border-radius: 8px;';
                    card.innerHTML = `<strong>åº—å:</strong> ${data.place||'ä¸æ˜'}<br><strong>æ—¥ä»˜:</strong> ${data.date||'ä¸æ˜'}<br><strong>åˆè¨ˆ:</strong> ${new Intl.NumberFormat().format(data.total||0)} å††`;
                    card.onclick = () => {
                        document.getElementById('place').value = data.place || '';
                        if(data.date && data.date !== 'ä¸æ˜') document.getElementById('date').value = data.date;
                        const container = document.getElementById('split-items-container');
                        container.innerHTML = '';
                        addSplitItemRow(container);
                        container.querySelector('.split-amount').value = data.total || '';
                        updateSplitTotal();
                        alert(`ã€Œ${data.place}ã€ã®æƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¾ã—ãŸã€‚`);
                    };
                    resultsDiv.appendChild(card);
                });
                usageCount++;
                localStorage.setItem(`ocrUsage_${today}`, usageCount);
                statusDiv.textContent = `${resultsArray.length}ä»¶ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`;

            } catch (err) {
                console.error("OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼:", err);
                statusDiv.textContent = 'å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'é¸æŠã—ãŸãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿å–ã‚‹';
                uploader.value = '';
            }
        }
        
        function handleAuthClick(isSilent = false) {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { if(isSilent) return; throw (resp); }
                localStorage.setItem('google_auth_loggedin', 'true');
                document.getElementById('signout_button').style.display = 'block';
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('auth-status').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿';
                document.getElementById('backup_button').disabled = false;
                document.getElementById('restore_button').disabled = false;
                await findOrCreateBackupFile();
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: isSilent ? '' : 'consent' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('google_auth_loggedin');
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
                document.getElementById('auth-status').textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                document.getElementById('backup_button').disabled = true;
                document.getElementById('restore_button').disabled = true;
                backupFileId = null;
            }
        }

        async function findOrCreateBackupFile() { /* å®Ÿè£…ã¯çœç•¥ */ }
        async function backupToDrive() { /* å®Ÿè£…ã¯çœç•¥ */ }
        async function restoreFromDrive() { /* å®Ÿè£…ã¯çœç•¥ */ }
        
        function renderBalanceGraph() {
            const area = document.getElementById('balanceGraphArea');
            area.innerHTML = '<canvas id="balanceTrendChart" style="max-width:100%;"></canvas>';
            const ctx = document.getElementById('balanceTrendChart').getContext('2d');
            const [year, month] = currentMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();

            let dailyChange = Array(daysInMonth).fill(0);
            transactions.filter(t => t.date && t.date.startsWith(currentMonth)).forEach(t => {
                const day = new Date(t.date).getDate() - 1;
                dailyChange[day] += (t.type === 'income' ? t.amount : -t.amount);
            });

            let balanceTrend = [];
            let currentBalance = accountBalance;
            let monthStartBalance = currentBalance - dailyChange.reduce((acc, val, i) => {
                 return new Date(currentMonth + `-${i+1}`).getDate() <= new Date().getDate() ? acc + val : acc;
            }, 0);


            for (let i = 0; i < daysInMonth; i++) {
                if(i > 0) monthStartBalance += dailyChange[i-1];
                balanceTrend.push(monthStartBalance);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: daysInMonth }, (_, i) => `${i + 1}æ—¥`),
                    datasets: [{
                        label: 'å£åº§æ®‹é«˜æ¨ç§»',
                        data: balanceTrend,
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46,125,50,0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: false, title: { display: true, text: 'æ®‹é«˜(å††)' } } }
                },
            });
        }
        
        function checkVariableExpensesIfNeeded() {
            const today = new Date();
            const [year, month] = currentMonth.split('-').map(Number);
            if (today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === variableExpenseCheckDay) {
                // promptVariableExpenses(currentMonth); // ã“ã®é–¢æ•°ã¯æœªå®šç¾©ã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
            }
        }

        function addFixedExpensesForMonth(month) {
            genres.filter(g => g.type === 'fixed').forEach(g => {
                const budget = budgetsByMonth[month]?.[g.name];
                if (budget) {
                    const alreadyExists = transactions.some(t => t.date === `${month}-01` && t.genre === g.name && t.memo === 'å®šæœŸæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰');
                    if (!alreadyExists) {
                        transactions.push({
                            date: `${month}-01`,
                            place: g.name,
                            type: 'expense',
                            genre: g.name,
                            amount: budget,
                            memo: 'å®šæœŸæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰',
                            tags: 'å®šæœŸ',
                            timestamp: generateUniqueId()
                        });
                    }
                }
            });
            saveData();
        }

        // --- DOMèª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            document.getElementById('homeTab').addEventListener('click', () => switchTab('home'));
            document.getElementById('settingsTab').addEventListener('click', () => switchTab('settings'));
            document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
            document.getElementById('add-split-item-btn').addEventListener('click', () => addSplitItemRow(document.getElementById('split-items-container')));
            document.getElementById('addGenreBtn').addEventListener('click', addGenre);
            document.getElementById('setBudgetBtn').addEventListener('click', setBudget);
            document.getElementById('copyBudgetBtn').addEventListener('click', copyLastMonthBudget);
            document.getElementById('monthSelector').addEventListener('change', e => {
                const newMonth = e.target.value;
                if (newMonth !== currentMonth) {
                    currentMonth = newMonth;
                    addFixedExpensesForMonth(currentMonth); // æœˆå¤‰æ›´æ™‚ã«å›ºå®šè²»ã‚’ãƒã‚§ãƒƒã‚¯ãƒ»è¿½åŠ 
                    renderApp();
                }
            });
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataButton').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', e => importData(e.target.files[0]));
            
            const apiKeyInput = document.getElementById('apiKeyInput');
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('saveApiKeyBtn').addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                }
            });

            document.getElementById('process-receipts-btn').addEventListener('click', handleReceiptProcessing);
            document.getElementById('authorize_button').addEventListener('click', () => handleAuthClick(false));
            document.getElementById('signout_button').addEventListener('click', handleSignoutClick);
            document.getElementById('backup_button').addEventListener('click', backupToDrive);
            document.getElementById('restore_button').addEventListener('click', restoreFromDrive);
            
            document.getElementById('monthlyReportBtn').addEventListener('click', () => {
                const area = document.getElementById('monthlyReportArea');
                area.style.display = area.style.display === 'block' ? 'none' : 'block'; // ãƒˆã‚°ãƒ«è¡¨ç¤º
                if (area.style.display === 'block') {
                   updateBudgetTable(); // ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’æ›´æ–°
                   area.innerHTML = document.getElementById('budgetTableArea').innerHTML;
                }
            });

            document.getElementById('saveAccountBalanceBtn').addEventListener('click', () => {
                const val = parseInt(document.getElementById('accountBalanceInput').value);
                if (!isNaN(val)) {
                    accountBalance = val;
                    saveData();
                    alert('å£åº§æ®‹é«˜ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    renderBalanceGraph();
                }
            });
            
            document.getElementById('saveVariableExpenseCheckDayBtn').addEventListener('click', () => {
                const val = parseInt(document.getElementById('variableExpenseCheckDay').value);
                if (!isNaN(val) && val >= 1 && val <= 31) {
                    variableExpenseCheckDay = val;
                    saveData();
                    document.getElementById('variableExpenseCheckDayStatus').textContent = `ç¾åœ¨ã®ç¢ºèªæ—¥ã¯æ¯æœˆ${val}æ—¥ã§ã™ã€‚`;
                    alert('å¤‰å‹•æ”¯å‡ºç¢ºèªæ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                } else {
                    alert('1ï½31ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
            });

            const container = document.getElementById('split-items-container');
            addSplitItemRow(container);
            updateSplitTotal();
            document.getElementById('date').valueAsDate = new Date();
            
            addFixedExpensesForMonth(currentMonth); // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«å›ºå®šè²»ã‚’ãƒã‚§ãƒƒã‚¯
            switchTab('home');
            renderApp();
        });
    </script>
</body>
</html>