<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>かものはし家計簿</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        :root{--primary-color:#2e7d32;--primary-dark-variant:#266b2a;--primary-light-variant:#5cb85c;--background-light:#f8f8f8;--card-bg-light:#fff;--text-color-light:#333;--border-color-light:#e0e0e0}
        *,*::before,*::after{box-sizing:border-box}
        body{margin:0;font-family:'Noto Sans JP',sans-serif;padding-bottom:90px;background-color:var(--background-light);color:var(--text-color-light)}
        @media (prefers-color-scheme:dark){:root{--background-light:#121212;--card-bg-light:#1e1e1e;--text-color-light:#e0e0e0;--border-color-light:#444}}
        header{display:flex;align-items:center;padding:1rem;background-color:var(--primary-dark-variant);color:#fff;width:100%;max-width:48rem;margin:0 auto;box-shadow:0 4px 6px rgba(0,0,0,.1);border-bottom-left-radius:.75rem;border-bottom-right-radius:.75rem}
        header img{width:64px;height:64px;margin-right:1rem}
        header h1{font-size:1.75rem;font-weight:700;margin:0}
        main{display:flex;flex-direction:column;align-items:center;width:100%;max-width:48rem;margin:2rem auto;padding:0 1rem}
        section{background-color:var(--card-bg-light);padding:1.5rem;border-radius:.75rem;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:1.5rem;width:100%}
        h2{font-size:1.25rem;font-weight:700;margin-top:0;margin-bottom:1rem}
        .tab-buttons{position:fixed;bottom:0;left:0;right:0;background-color:var(--primary-dark-variant);box-shadow:0 -4px 6px rgba(0,0,0,.1);display:flex;justify-content:space-around;padding:.75rem;z-index:10}
        .tab-buttons button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.5rem 0;border:none;background-color:transparent;color:#fff;font-size:.75rem;border-radius:.5rem;transition:background-color .2s}
        .tab-buttons button.active{background-color:var(--primary-light-variant)}
        .tab-buttons button span{font-size:1.5rem;line-height:1}
        form input,form select,form button{width:100%;padding:.75rem;border-radius:.5rem;border:1px solid var(--border-color-light);font-size:1rem;margin-bottom:.75rem}
        button{background-color:var(--primary-color);color:#fff;font-weight:700;border:none;cursor:pointer;transition:background-color .2s;border-radius:.5rem;padding:.75rem 1rem}
        button:hover{background-color:var(--primary-light-variant)}
        .split-item-row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}.split-item-row select,.split-item-row input{flex:1}
        .split-item-row button{flex-shrink:0;width:auto;padding:.5rem .75rem;font-size:1rem;line-height:1;background-color:#ef4444}
        #total-split-amount{font-size:1.25rem;font-weight:700;text-align:right;margin-top:1rem;color:var(--primary-dark-variant)}
        table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.875rem}th,td{padding:.75rem .5rem;border:1px solid var(--border-color-light);text-align:center}
        tr.split-group-start > td{border-top:2px solid var(--primary-color) !important}
        tr.split-child > td{border-top:1px dashed #ccc !important}
        .split-child .split-info-cell{color:#9ca3af}
        .calendar-grid-container{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center}.calendar-day-header{font-weight:700;font-size:.8rem;padding-bottom:4px}.calendar-day-cell{border:1px solid var(--border-color-light);border-radius:.5rem;padding:4px;min-height:60px;display:flex;flex-direction:column;align-items:center;font-size:.8rem}.calendar-expense-amount{font-size:.7rem;color:red;font-weight:700;margin-top:4px}
        .scroll-table{overflow-x:auto}
        button, input, select { min-height: 48px; font-size: 1.1rem; }
        .tab-buttons button { min-height: 48px; font-size: 1rem; }
        input[type="date"], input[type="number"], input[type="text"], select { font-size: 1.1rem; padding: 0.75rem 0.5rem; }
        @media (max-width: 600px) {
            main, section { padding: 0.5rem; }
            h1, h2 { font-size: 1.1rem; }
            table th, table td { font-size: 0.95rem; padding: 0.5rem 0.25rem; }
        }
    </style>
</head>
<body>
    <header>
        <img src="icon-512.png" alt="かものはし家計簿ロゴ">
        <h1>かものはし家計簿</h1>
    </header>
    <main id="mainContent">
        <div id="homeSection">
             <section>
                <h2><span style="font-size:1.5rem;margin-right:8px;">📷</span>レシート自動入力 (OCR)</h2>
                <input type="file" id="receipt-uploader" accept="image/*" capture="environment">
                <button id="process-receipts-btn" style="margin-top:0.5rem;">選択したレシートを読み取る</button>
                <div id="ocr-status" style="text-align:center;margin-top:1rem;font-weight:bold;"></div>
                <div id="ocr-results" style="margin-top:1rem;display:flex;flex-direction:column;gap:8px;"></div>
            </section>
            <section>
                <h2>支出・収入の記録</h2>
                <form id="recordForm">
                    <div style="display:flex;gap:1rem;"><input type="date" id="date" required><select id="type"><option value="expense">支出</option><option value="income">収入</option></select></div>
                    <input type="text" id="place" placeholder="場所（例：スーパーA）" required>
                    <div id="split-items-container" class="space-y-2 border-t border-b py-4 my-2"></div>
                    <button type="button" id="add-split-item-btn" style="background-color:#e5e7eb;color:#1f2937;">＋ 項目を追加</button>
                    <div id="total-split-amount">合計: ¥0</div>
                    <input type="text" id="tags" placeholder="タグ（グループ全体に適用）">
                    <input type="text" id="memo" placeholder="備考（グループ全体に適用）">
                    <button type="submit">記録</button>
                </form>
            </section>
            <section>
                <h2>
                    <input type="month" id="monthSelector" style="font-size:1.25rem;border:none;padding-left:0;width:auto;">の状況
                </h2>
                <div id="budgetTableArea" style="margin-bottom:1rem;"></div>
                 <div id="budgetProgressBars" style="margin-top:1.5rem;"></div>
                <div class="calendar-grid-container" style="margin-top:1.5rem;"></div>
            </section>
            <section>
                <h2>履歴</h2>
                 <button id="monthlyReportBtn" style="margin-bottom:1rem;">📊 月次レポートを見る</button>
                <div id="monthlyReportArea" style="margin-top:1rem; margin-bottom:1rem;"></div>
                <div class="scroll-table"><table><thead><tr><th>日付</th><th>場所</th><th>金額</th><th>ジャンル</th><th>メモ</th><th>タグ</th><th>操作</th></tr></thead><tbody id="historyBody"></tbody></table></div>
            </section>
            <section>
              <h2>口座残高</h2>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" id="accountBalanceInput" placeholder="現在の口座残高" style="flex:1;">
                <button id="saveAccountBalanceBtn" style="width:auto;">保存</button>
              </div>
              <div id="balanceGraphArea" style="margin:1rem 0;"></div>
            </section>
        </div>
        <div id="settingsSection" style="display:none;">
            <section>
                <h2>Google Drive バックアップ</h2>
                <div id="auth-status" style="margin-bottom:1rem;font-weight:bold;">初期化中...</div>
                <div style="display:flex;gap:8px;">
                    <button id="authorize_button" style="background-color:#4285F4;visibility:hidden;">Googleでログイン</button>
                    <button id="signout_button" style="display:none;background-color:#db4437;">ログアウト</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button id="backup_button" disabled>Driveへバックアップ</button>
                    <button id="restore_button" disabled>Driveから復元</button>
                </div>
                <div id="backup-status" style="text-align:center;margin-top:1rem;"></div>
            </section>
            <section>
                <h2>ジャンルの管理</h2>
                <div style="display:flex;gap:8px;">
                    <input type="text" id="newGenre" placeholder="新しいジャンル名">
                    <select id="newGenreType">
                        <option value="">通常</option>
                        <option value="fixed">定期（固定）</option>
                        <option value="variable">定期（変動）</option>
                    </select>
                    <input type="number" id="newGenreDueDay" min="1" max="31" placeholder="発生日 (任意)">
                    <button id="addGenreBtn" style="width:auto;flex-shrink:0;">追加</button>
                </div>
                <div id="genreList" style="margin-top:1rem;"></div>
            </section>
            <section>
                <h2>予算の設定</h2>
                <div style="display:flex;gap:8px;"><select id="budgetGenre" style="flex:1;"></select><input type="number" id="budgetAmount" placeholder="金額" style="flex:1;"><button id="setBudgetBtn" style="width:auto;flex-shrink:0;">設定</button></div>
                <button id="copyBudgetBtn" style="width:100%;margin-top:8px;">先月の予算をコピー</button>
            </section>
            <section>
                <h2>Gemini API キー設定</h2>
                <input type="password" id="apiKeyInput" placeholder="ここにGemini APIキーを貼り付け">
                <button id="saveApiKeyBtn" style="margin-top:0.5rem;">APIキーを保存</button>
            </section>
            <section>
                <h2>データのエクスポート / インポート</h2>
                <button id="exportDataBtn">📤 エクスポート</button>
                <input type="file" id="importFileInput" style="display:none;" accept=".json">
                <button id="importDataButton" style="margin-top:8px;">📥 インポート</button>
            </section>
            <section>
                <h2>変動支出確認日と発生日</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="number" id="variableExpenseCheckDay" min="1" max="31" placeholder="確認日 (毎月)" style="flex:1;">
                    <button id="saveVariableExpenseCheckDayBtn" style="width:auto;">保存</button>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                    <input type="number" id="variableExpenseDueDay" min="1" max="31" placeholder="発生日 (毎月)" style="flex:1;">
                    <button id="saveVariableExpenseDueDayBtn" style="width:auto;">保存</button>
                </div>
                <div id="variableExpenseStatus" style="margin-top:0.5rem;color:#666;font-size:0.95rem;"></div>
            </section>
        </div>
    </main>
    <div class="tab-buttons">
        <button id="homeTab" class="active"><span>🏠</span>ホーム</button>
        <button id="settingsTab"><span>⚙️</span>設定</button>
    </div>

    <div id="editTransactionModal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#fff;padding:1rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:1000;">
        <h2>履歴の編集</h2>
        <form id="editTransactionForm">
            <label>日付: <input type="date" id="editDate" required></label><br>
            <label>場所: <input type="text" id="editPlace" required></label><br>
            <label>金額: <input type="number" id="editAmount" required></label><br>
            <label>ジャンル: 
                <select id="editGenre"></select>
            </label><br>
            <label>メモ: <input type="text" id="editMemo"></label><br>
            <label>タグ: <input type="text" id="editTags"></label><br>
            <button type="submit">保存</button>
            <button type="button" id="cancelEditBtn">キャンセル</button>
        </form>
    </div>
    <div id="modalOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;"></div>
    <div id="editGenreModal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#fff;padding:1rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:1000;">
        <h2>ジャンルの編集</h2>
        <form id="editGenreForm">
            <label>ジャンル名: <input type="text" id="editGenreName" required></label><br>
            <label>ジャンルタイプ: 
                <select id="editGenreType">
                    <option value="">通常</option>
                    <option value="fixed">定期（固定）</option>
                    <option value="variable">定期（変動）</option>
                </select>
            </label><br>
            <label>発生日: <input type="number" id="editGenreDueDay" min="1" max="31" placeholder="発生日 (任意)"></label><br>
            <button type="submit">保存</button>
            <button type="button" id="cancelEditGenreBtn">キャンセル</button>
        </form>
    </div>
    <div id="editGenreOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;"></div>

    <script>
        // --- グローバル変数 ---
        let transactions = [];
        let genres = [
          { name: '食費', type: '' },
          { name: '家賃', type: 'fixed' },
          { name: 'クレジットカード', type: 'variable' },
        ];
        let budgetsByMonth = {};
        let rolloverGenres = [];
        let currentMonth = new Date().toISOString().slice(0, 7);
        let budgetPieChart = null;
        let accountBalance = 0;
        let variableExpenseCheckDay = 1;
        let variableExpenseDueDay = 1; // Added initialization for variableExpenseDueDay
        const LOCAL_STORAGE_KEY = 'kakeiboData';

        // --- Google Drive API関連 ---
        const API_KEY = 'AIzaSyA8SHDfUl1CWayCmq6oGREjnxWR6R8vPkM'; // ★GitHubに上げる際は必ずプレースホルダーに戻すこと！
        const CLIENT_ID = '98738563895-d80ev131bgogmct7hi0qv3ojopu52dsj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const BACKUP_FILENAME = 'kakeibo_backup.json';
        let tokenClient, gapiInited = false, gsiInited = false, backupFileId = null;

        // --- Google API初期化コールバック ---
        window.gapiLoaded = () => gapi.load('client', initializeGapiClient);
        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gsiInited = true;
            maybeInitAuth();
        };

        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            maybeInitAuth();
        }

        function maybeInitAuth() {
            const authStatus = document.getElementById('auth-status');
            if (gapiInited && gsiInited) {
                authStatus.textContent = '未ログイン';
                document.getElementById('authorize_button').style.visibility = 'visible';
                if (localStorage.getItem('google_auth_loggedin') === 'true') {
                   handleAuthClick(true);
                }
            }
        }

        // --- データ管理 ---
        function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }

        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!storedData) return;
            const data = JSON.parse(storedData);
            transactions = data.transactions || [];
            genres = data.genres || [ { name: '食費', type: '' }, { name: '家賃', type: 'fixed' }, { name: 'クレジットカード', type: 'variable' } ];
            budgetsByMonth = data.budgetsByMonth || data.budgets || {};
            rolloverGenres = data.rolloverGenres || [];
            accountBalance = parseInt(localStorage.getItem('accountBalance') || '0');
            variableExpenseCheckDay = parseInt(localStorage.getItem('variableExpenseCheckDay') || '1');
            variableExpenseDueDay = parseInt(localStorage.getItem('variableExpenseDueDay') || '1');
        }

        function saveData() {
            const dataToSave = { transactions, genres, budgetsByMonth, rolloverGenres };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            localStorage.setItem('accountBalance', accountBalance);
            localStorage.setItem('variableExpenseCheckDay', variableExpenseCheckDay);
            localStorage.setItem('variableExpenseDueDay', variableExpenseDueDay);
        }

        // --- UI更新 ---
        function renderApp() {
            document.getElementById('monthSelector').value = currentMonth;
            document.getElementById('accountBalanceInput').value = accountBalance || '';
            document.getElementById('variableExpenseCheckDay').value = variableExpenseCheckDay || '';
            document.getElementById('variableExpenseDueDay').value = variableExpenseDueDay || '';
            document.getElementById('variableExpenseStatus').textContent = `現在の発生日は毎月${variableExpenseDueDay}日です。`;

            updateHistoryTable();
            updateGenreManagementList();
            updateBudgetGenreSelector();
            updateSplitItemGenreSelects();
            updateCalendarView();
            updateBudgetTable();
            updateBudgetProgressBars();
            renderBalanceGraph();
            checkVariableExpensesIfNeeded();
        }

        function switchTab(tabName) {
            document.getElementById('homeSection').style.display = (tabName === 'home' ? 'block' : 'none');
            document.getElementById('settingsSection').style.display = (tabName === 'settings' ? 'block' : 'none');
            document.getElementById('homeTab').classList.toggle('active', tabName === 'home');
            document.getElementById('settingsTab').classList.toggle('active', tabName === 'settings');
        }

        function updateGenreManagementList() {
            const genreListDiv = document.getElementById('genreList');
            genreListDiv.innerHTML = '';
            genres.forEach((g, index) => {
                const isRolloverEnabled = rolloverGenres.includes(g.name);
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:4px;border-bottom:1px solid var(--border-color-light)';
                itemDiv.setAttribute('draggable', 'true');
                itemDiv.setAttribute('data-index', index);
                itemDiv.innerHTML = `
                    <span>${g.name || ''} (${g.type || '通常'})</span>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="number" class="genre-due-day" data-genre="${g.name}" value="${g.dueDay || ''}" min="1" max="31" placeholder="発生日">
                        <label style="font-size:0.8rem;">
                            <input type="checkbox" class="rollover-checkbox" data-genre="${g.name}" ${isRolloverEnabled ? 'checked' : ''}> 繰越
                        </label>
                        <button class="edit-genre-btn" data-index="${index}" style="width:auto;padding:2px 6px;background-color:#4caf50;color:#fff;">編集</button>
                        <button class="delete-btn" data-genre="${g.name}" style="width:auto;padding:2px 6px;background-color:#ef4444;">&times;</button>
                    </div>`;
                genreListDiv.appendChild(itemDiv);

                // イベントリスナーを追加
                itemDiv.querySelector('.edit-genre-btn').addEventListener('click', (e) => openEditGenreModal(e.target.dataset.index));
                itemDiv.querySelector('.delete-btn').addEventListener('click', (e) => deleteGenre(e.target.dataset.genre));
                itemDiv.querySelector('.rollover-checkbox').addEventListener('change', (e) => handleRolloverChange(e.target.dataset.genre, e.target.checked));
                itemDiv.querySelector('.genre-due-day').addEventListener('change', (e) => updateGenreDueDay(e.target.dataset.genre, e.target.value));
            });
        }

        let draggedItemIndex = null;

        function handleDragStart(e) {
            draggedItemIndex = parseInt(e.target.getAttribute('data-index'));
            e.target.style.opacity = '0.5'; // ドラッグ中のアイテムを半透明にする
        }

        function handleDragOver(e) {
            e.preventDefault(); // ドロップを許可する
            e.target.style.border = '2px dashed var(--primary-color)'; // ドラッグ中のアイテムの上に枠線を表示
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetIndex = parseInt(e.target.closest('[data-index]').getAttribute('data-index'));
            if (draggedItemIndex !== null && targetIndex !== null && draggedItemIndex !== targetIndex) {
                // ジャンルの順序を入れ替える
                const draggedItem = genres[draggedItemIndex];
                genres.splice(draggedItemIndex, 1);
                genres.splice(targetIndex, 0, draggedItem);

                // データを保存してUIを更新
                saveData();
                updateGenreManagementList();
            }
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1'; // ドラッグ終了後に透明度を元に戻す
            document.querySelectorAll('[data-index]').forEach(item => {
                item.style.border = ''; // 枠線を消す
            });
        }

        function updateGenreDueDay(genreName, dueDay) {
            const genre = genres.find(g => g.name === genreName);
            if (genre) {
                genre.dueDay = parseInt(dueDay) || null;
                saveData();
            }
        }

        function updateHistoryTable() {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '';
            const filtered = transactions.filter(t => t.date && t.date.startsWith(currentMonth));
            const sorted = filtered.sort((a, b) => b.date.localeCompare(a.date) || (b.timestamp > a.timestamp ? -1 : 1));
            sorted.forEach((transaction, index) => {
                const row = historyBody.insertRow();
                let isSplitChild = transaction.splitGroupId && index > 0 && sorted[index - 1].splitGroupId === transaction.splitGroupId;
                if (transaction.splitGroupId && !isSplitChild) row.classList.add('split-group-start');
                if (isSplitChild) row.classList.add('split-child');
                const infoCell = (content) => isSplitChild ? `<span class="split-info-cell">${content || ''}</span>` : `<span>${content || ''}</span>`;
                row.innerHTML = `
                    <td>${infoCell(transaction.date || '')}</td>
                    <td>${infoCell(transaction.place || '')}</td>
                    <td style="color:${transaction.type === 'expense' ? 'red' : 'green'};">${new Intl.NumberFormat().format(transaction.amount || 0)}円</td>
                    <td>${transaction.genre || ''}</td>
                    <td>${infoCell(transaction.memo || '')}</td>
                    <td>${infoCell(transaction.tags || '')}</td>
                    <td>
                        <button class="edit-btn" data-timestamp="${transaction.timestamp}" style="background-color:#4caf50;padding:4px 8px;width:auto;">編集</button>
                        <button class="delete-btn" data-timestamp="${transaction.timestamp}" style="background-color:#ef4444;padding:4px 8px;width:auto;">削除</button>
                    </td>`;
                row.querySelector('.delete-btn').addEventListener('click', (e) => deleteTransaction(e.target.dataset.timestamp));
                row.querySelector('.edit-btn').addEventListener('click', (e) => editTransaction(e.target.dataset.timestamp));
            });
        }

        function updateCalendarView() {
            const calendarContainer = document.querySelector('.calendar-grid-container');
            calendarContainer.innerHTML = '';
            const dayHeaders = ['日','月','火','水','木','金','土'];
            dayHeaders.forEach(day => calendarContainer.insertAdjacentHTML('beforeend', `<div class="calendar-day-header">${day}</div>`));
            const [year, month] = currentMonth.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyTotals = {};
            transactions.filter(t => t.date && t.date.startsWith(currentMonth) && t.type === 'expense').forEach(t => {
                const day = new Date(t.date).getDate();
                dailyTotals[day] = (dailyTotals[day] || 0) + t.amount;
            });
            for (let i = 0; i < firstDay; i++) calendarContainer.insertAdjacentHTML('beforeend', '<div></div>');
            for (let day = 1; day <= daysInMonth; day++) {
                let content = `<span class="calendar-day-number">${day}</span>`;
                if (dailyTotals[day]) content += `<span class="calendar-expense-amount">${new Intl.NumberFormat().format(dailyTotals[day])}円</span>`;
                calendarContainer.insertAdjacentHTML('beforeend', `<div class="calendar-day-cell">${content}</div>`);
            }
        }

        function updateBudgetTable() {
            const area = document.getElementById('budgetTableArea');
            const monthlyBudget = budgetsByMonth[currentMonth] || {};
            let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr><th>ジャンル</th><th>予算</th><th>支出</th><th>残額</th></tr></thead><tbody>';
            Object.keys(monthlyBudget).forEach(genre => {
                const budget = monthlyBudget[genre];
                const spent = transactions
                    .filter(t => t.date && t.date.startsWith(currentMonth) && t.genre === genre && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                html += `<tr>
                    <td>${genre}</td>
                    <td>${new Intl.NumberFormat().format(budget)}円</td>
                    <td>${new Intl.NumberFormat().format(spent)}円</td> <!-- 文字色を変更 -->
                    <td>${new Intl.NumberFormat().format(budget - spent)}円</td>
                </tr>`;
            });
            html += '</tbody></table>';
            area.innerHTML = html;
        }

        function updateBudgetProgressBars(){} // 実装は省略

        function addSplitItemRow(container) {
            const row = document.createElement('div');
            row.className = 'split-item-row';
            const genreSelect = document.createElement('select');
            genreSelect.className = 'split-genre';
            updateGenreOptions(genreSelect);
            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.className = 'split-amount';
            amountInput.placeholder = '金額';
            amountInput.min = '0';
            amountInput.addEventListener('input', updateSplitTotal);
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.textContent = '✖';
            deleteBtn.addEventListener('click', () => { if (container.querySelectorAll('.split-item-row').length > 1) { row.remove(); updateSplitTotal(); }});
            row.appendChild(genreSelect);
            row.appendChild(amountInput);
            row.appendChild(deleteBtn);
            container.appendChild(row);
        }

        function updateGenreOptions(selectElement) {
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            genres.filter(g => !['給与', 'その他収入'].includes(g.name)).forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                selectElement.appendChild(option);
            });
            if(currentVal) selectElement.value = currentVal;
        }

        function updateSplitItemGenreSelects() { document.querySelectorAll('.split-genre').forEach(updateGenreOptions); }

        function updateSplitTotal() {
            const container = document.getElementById('split-items-container');
            const amounts = Array.from(container.querySelectorAll('.split-amount'));
            const total = amounts.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            document.getElementById('total-split-amount').textContent = `合計: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(total)}`;
        }

        function handleRecordSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('date').value,
                place = document.getElementById('place').value,
                type = document.getElementById('type').value,
                memo = document.getElementById('memo').value,
                tags = document.getElementById('tags').value,
                splitItems = document.querySelectorAll('.split-item-row');
            if (!place) { alert('場所を入力してください。'); return; }
            const splitGroupId = generateUniqueId();
            let recordsToAdd = [];
            splitItems.forEach(item => {
                const genre = item.querySelector('.split-genre').value;
                const amount = parseInt(item.querySelector('.split-amount').value);
                if (genre && amount > 0) {
                    recordsToAdd.push({ date, place, type, memo, tags, genre, amount, splitGroupId, timestamp: generateUniqueId() });
                }
            });
            if (recordsToAdd.length > 0) {
                transactions.push(...recordsToAdd);
                saveData();
                renderApp();
                document.getElementById('recordForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                const container = document.getElementById('split-items-container');
                container.innerHTML = '';
                addSplitItemRow(container);
                updateSplitTotal();
            } else {
                alert('有効な金額を持つ項目がありません。');
            }
        }

        function deleteTransaction(timestamp) {
            const txToDelete = transactions.find(t => t.timestamp === timestamp);
            if (!txToDelete) return;
            let msg = 'この記録を削除しますか？';
            if (txToDelete.splitGroupId && transactions.filter(t => t.splitGroupId === txToDelete.splitGroupId).length > 1) {
                msg = 'これは分割記録の一部です。この項目のみ削除しますか？';
            }
            if (window.confirm(msg)) {
                transactions = transactions.filter(t => t.timestamp !== timestamp);
                saveData();
                renderApp();
            }
        }

        function addGenre() {
            const newGenreInput = document.getElementById('newGenre');
            const newGenreType = document.getElementById('newGenreType').value;
            const newGenreDueDay = parseInt(document.getElementById('newGenreDueDay').value) || null;
            const newGenreName = newGenreInput.value.trim();

            if (newGenreName && !genres.some(g => g.name === newGenreName)) {
                genres.push({ name: newGenreName, type: newGenreType, dueDay: newGenreDueDay });
                saveData();
                renderApp();
                newGenreInput.value = '';
                document.getElementById('newGenreDueDay').value = '';
            }
        }

        function deleteGenre(genreName) {
            if (window.confirm(`「${genreName}」を削除しますか？`)) {
                genres = genres.filter(g => g.name !== genreName);
                rolloverGenres = rolloverGenres.filter(g => g !== genreName);
                saveData();
                renderApp();
            }
        }

        function updateBudgetGenreSelector() {
            const budgetGenreSelect = document.getElementById('budgetGenre');
            if(!budgetGenreSelect) return;
            budgetGenreSelect.innerHTML = '';
            genres.forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                budgetGenreSelect.appendChild(option);
            });
        }

        function setBudget() {
             const genre = document.getElementById('budgetGenre').value;
             const amount = parseInt(document.getElementById('budgetAmount').value);
             if (genre && !isNaN(amount)) {
                if(!budgetsByMonth[currentMonth]) budgetsByMonth[currentMonth] = {};
                budgetsByMonth[currentMonth][genre] = amount;
                saveData();
                renderApp();
             }
        }

        function copyLastMonthBudget() {
            const date = new Date(currentMonth + '-01');
            date.setMonth(date.getMonth() - 1);
            const lastMonthKey = date.toISOString().slice(0, 7);
            if (budgetsByMonth[lastMonthKey]) {
                budgetsByMonth[currentMonth] = { ...budgetsByMonth[lastMonthKey] };
                saveData();
                renderApp();
                alert(`${lastMonthKey}の予算をコピーしました。`);
            } else {
                alert('前月の予算データがありません。');
            }
        }

        function handleRolloverChange(genre, isChecked) {
            const index = rolloverGenres.indexOf(genre);
            if (isChecked && index === -1) rolloverGenres.push(genre);
            else if (!isChecked && index > -1) rolloverGenres.splice(index, 1);
            saveData();
        }

        function exportData() {
            const dataStr = JSON.stringify({ transactions, genres, budgetsByMonth, rolloverGenres }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kakeibo_data_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm('データをインポートしますか？現在のデータは上書きされます。')) {
                        transactions = data.transactions || [];
                        genres = data.genres || [];
                        budgetsByMonth = data.budgetsByMonth || {};
                        rolloverGenres = data.rolloverGenres || [];
                        saveData();
                        renderApp();
                    }
                } catch (err) {
                    alert('ファイルの読み込みに失敗しました。');
                }
            };
            reader.readAsText(file);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function handleReceiptProcessing() {
            const uploader = document.getElementById('receipt-uploader');
            const statusDiv = document.getElementById('ocr-status');
            const resultsDiv = document.getElementById('ocr-results');
            const processBtn = document.getElementById('process-receipts-btn');

            processBtn.disabled = true;
            processBtn.textContent = '読み取り中...';

            try {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    alert('APIキーが設定されていません。「設定」画面でAPIキーを保存してください。');
                    switchTab('settings');
                    return;
                }

                const files = uploader.files;
                if (files.length === 0) {
                    alert('レシート画像を選択してください。');
                    return;
                }
                if (files.length > 1) {
                    alert('複数レシートの一括読み取りでは、一度に1枚の画像のみ選択してください。');
                    return;
                }

                statusDiv.textContent = '処理を開始します...';
                resultsDiv.innerHTML = '';
                const SAFE_LIMIT_PER_DAY = 50;
                const today = new Date().toISOString().slice(0, 10);
                let usageCount = parseInt(localStorage.getItem(`ocrUsage_${today}`) || '0');

                if (usageCount >= SAFE_LIMIT_PER_DAY) {
                    statusDiv.textContent = `1日の上限（${SAFE_LIMIT_PER_DAY}回）に達しました。`;
                    return;
                }

                const file = files[0];
                statusDiv.textContent = `${file.name} を読み取り中...`;

                const genAI = new window.GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const base64Image = await fileToBase64(file);
                const prompt = `この1枚の画像に写っている全てのレシートを個別に認識し、各レシートから以下の情報を抽出し、必ずJSONの配列（リスト）形式で回答してください。- place: 店名 (文字列) - date: 日付 (YYYY-MM-DD形式の文字列) - total: 合計金額 (数値)`;
                const imagePart = { inlineData: { data: base64Image, mimeType: file.type } };
                const result = await model.generateContent([prompt, imagePart]);
                const responseText = result.response.text().replace(/```json|```/g, '').trim();
                const resultsArray = JSON.parse(responseText);

                if (resultsArray.length === 0) {
                    statusDiv.textContent = '画像からレシートを検出できませんでした。';
                    return;
                }

                resultsArray.forEach(data => {
                    const card = document.createElement('div');
                    card.style.cssText = 'border: 1px solid #ccc; padding: 12px; cursor: pointer; border-radius: 8px;';
                    card.innerHTML = `<strong>店名:</strong> ${data.place||'不明'}<br><strong>日付:</strong> ${data.date||'不明'}<br><strong>合計:</strong> ${new Intl.NumberFormat().format(data.total||0)} 円`;
                    card.onclick = () => {
                        document.getElementById('place').value = data.place || '';
                        if(data.date && data.date !== '不明') document.getElementById('date').value = data.date;
                        const container = document.getElementById('split-items-container');
                        container.innerHTML = '';
                        addSplitItemRow(container);
                        container.querySelector('.split-amount').value = data.total || '';
                        updateSplitTotal();
                        alert(`「${data.place}」の情報をフォームに入力しました。`);
                    };
                    resultsDiv.appendChild(card);
                });
                usageCount++;
                localStorage.setItem(`ocrUsage_${today}`, usageCount);
                statusDiv.textContent = `${resultsArray.length}件のレシートを検出しました。`;

            } catch (err) {
                console.error("OCR処理エラー:", err);
                statusDiv.textContent = '処理中にエラーが発生しました。';
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = '選択したレシートを読み取る';
                uploader.value = '';
            }
        }
        
        function handleAuthClick(isSilent = false) {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { if(isSilent) return; throw (resp); }
                localStorage.setItem('google_auth_loggedin', 'true');
                document.getElementById('signout_button').style.display = 'block';
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('auth-status').textContent = 'ログイン済み';
                document.getElementById('backup_button').disabled = false;
                document.getElementById('restore_button').disabled = false;
                await findOrCreateBackupFile();
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: isSilent ? '' : 'consent' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('google_auth_loggedin');
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
                document.getElementById('auth-status').textContent = '未ログイン';
                document.getElementById('backup_button').disabled = true;
                document.getElementById('restore_button').disabled = true;
                backupFileId = null;
            }
        }

        async function findOrCreateBackupFile() { /* 実装は省略 */ }
        async function backupToDrive() { /* 実装は省略 */ }
        async function restoreFromDrive() { /* 実装は省略 */ }
        
        function renderBalanceGraph() {
            const area = document.getElementById('balanceGraphArea');
            // Check if a chart already exists on the canvas and destroy it
            const existingChart = Chart.getChart("balanceTrendChart");
            if (existingChart) {
                existingChart.destroy();
            }
            area.innerHTML = '<canvas id="balanceTrendChart" style="max-width:100%;"></canvas>';
            const ctx = document.getElementById('balanceTrendChart').getContext('2d');
            const [year, month] = currentMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();

            // 日ごとの支出・収入集計
            let dailyChange = Array(daysInMonth).fill(0);
            transactions.filter(t => t.date && t.date.startsWith(currentMonth)).forEach(t => {
                const day = new Date(t.date).getDate() - 1;
                dailyChange[day] += (t.type === 'income' ? t.amount : -t.amount);
            });

            // 残高推移計算 (修正: 初日の残高から計算を開始)
            let balanceTrend = [];
            // 今月の初日時点での残高を計算
            let startingBalanceForMonth = accountBalance;
            // 当月より前の取引の差額を計算
            transactions.filter(t => t.date && t.date < `${currentMonth}-01`).forEach(t => {
                startingBalanceForMonth += (t.type === 'income' ? t.amount : -t.amount);
            });

            let currentDayBalance = startingBalanceForMonth;
            for (let i = 0; i < daysInMonth; i++) {
                currentDayBalance += dailyChange[i];
                balanceTrend.push(currentDayBalance);
            }

            // Y軸の最小値を計算
            const minBalance = Math.min(...balanceTrend, startingBalanceForMonth); // Include startingBalanceForMonth for min calculation
            const yAxisMin = Math.floor(minBalance / 1000) * 1000; // 最小値を1000円単位で切り下げ

            // グラフ描画
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: daysInMonth }, (_, i) => `${i + 1}日`),
                    datasets: [{
                        label: '口座残高推移',
                        data: balanceTrend,
                        borderColor: 'rgb(46,125,50)', // Added borderColor
                        backgroundColor: 'rgba(46,125,50,0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yAxisMin, // Y軸の最小値を設定
                            title: { display: true, text: '残高(円)' }
                        }
                    }
                },
            });
        }
        
        function checkVariableExpensesIfNeeded() {
            const today = new Date();
            const [year, month] = currentMonth.split('-').map(Number);
            // Check if the current month is the month being viewed in the selector
            // And if today's date matches the check day
            if (today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === variableExpenseCheckDay) {
                // Prevent showing the alert multiple times in the same day
                const lastAlertDate = localStorage.getItem('lastVariableExpenseAlert');
                if (lastAlertDate !== today.toISOString().slice(0, 10)) {
                    alert(`今月の変動支出は${variableExpenseDueDay}日に発生します。`);
                    localStorage.setItem('lastVariableExpenseAlert', today.toISOString().slice(0, 10));
                }
            }
        }

        function addFixedExpensesForMonth(month) {
            genres.filter(g => g.type === 'fixed').forEach(g => {
                const budget = budgetsByMonth[month]?.[g.name];
                if (budget) {
                    const alreadyExists = transactions.some(t => t.date === `${month}-01` && t.genre === g.name && t.memo === '定期支出（自動）');
                    if (!alreadyExists) {
                        transactions.push({
                            date: `${month}-01`,
                            place: g.name,
                            type: 'expense',
                            genre: g.name,
                            amount: budget,
                            memo: '定期支出（自動）',
                            tags: '定期',
                            timestamp: generateUniqueId()
                        });
                    }
                }
            });
            saveData();
        }

        function addVariableExpensesForMonth(month) {
            genres.filter(g => g.type === 'variable').forEach(g => {
                const budget = budgetsByMonth[month]?.[g.name];
                const dueDay = g.dueDay || variableExpenseDueDay; // ジャンルごとの発生日を優先
                if (budget) {
                    const formattedDueDay = String(dueDay).padStart(2, '0');
                    const alreadyExists = transactions.some(t => t.date === `${month}-${formattedDueDay}` && t.genre === g.name && t.memo === '変動支出（自動）');
                    if (!alreadyExists) {
                        transactions.push({
                            date: `${month}-${formattedDueDay}`,
                            place: g.name,
                            type: 'expense',
                            genre: g.name,
                            amount: budget,
                            memo: '変動支出（自動）',
                            tags: '変動',
                            timestamp: generateUniqueId()
                        });
                    }
                }
            });
            saveData();
        }

        // --- DOM読み込み後の初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            document.getElementById('homeTab').addEventListener('click', () => switchTab('home'));
            document.getElementById('settingsTab').addEventListener('click', () => switchTab('settings'));
            document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
            document.getElementById('add-split-item-btn').addEventListener('click', () => addSplitItemRow(document.getElementById('split-items-container')));
            document.getElementById('addGenreBtn').addEventListener('click', addGenre);
            document.getElementById('setBudgetBtn').addEventListener('click', setBudget);
            document.getElementById('copyBudgetBtn').addEventListener('click', copyLastMonthBudget);
            document.getElementById('monthSelector').addEventListener('change', e => {
                const newMonth = e.target.value;
                if (newMonth !== currentMonth) {
                    currentMonth = newMonth;
                    addFixedExpensesForMonth(currentMonth); // 固定費を追加
                    addVariableExpensesForMonth(currentMonth); // 変動費を追加
                    renderApp();
                }
            });
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataButton').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', e => importData(e.target.files[0]));
            
            const apiKeyInput = document.getElementById('apiKeyInput');
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('saveApiKeyBtn').addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    alert('APIキーを保存しました。');
                }
            });

            document.getElementById('process-receipts-btn').addEventListener('click', handleReceiptProcessing);
            document.getElementById('authorize_button').addEventListener('click', () => handleAuthClick(false));
            document.getElementById('signout_button').addEventListener('click', handleSignoutClick);
            document.getElementById('backup_button').addEventListener('click', backupToDrive);
            document.getElementById('restore_button').addEventListener('click', restoreFromDrive);
            
            document.getElementById('monthlyReportBtn').addEventListener('click', () => {
                const area = document.getElementById('monthlyReportArea');
                area.style.display = area.style.display === 'block' ? 'none' : 'block'; // トグル表示
                if (area.style.display === 'block') {
                   updateBudgetTable(); // レポート内容を更新
                   area.innerHTML = document.getElementById('budgetTableArea').innerHTML;
                }
            });

            document.getElementById('saveAccountBalanceBtn').addEventListener('click', () => {
                const val = parseInt(document.getElementById('accountBalanceInput').value);
                if (!isNaN(val)) {
                    accountBalance = val;
                    saveData();
                    alert('口座残高を保存しました。');
                    renderBalanceGraph();
                }
            });
            
            document.getElementById('saveVariableExpenseCheckDayBtn').addEventListener('click', () => {
                const val = parseInt(document.getElementById('variableExpenseCheckDay').value);
                if (!isNaN(val) && val >= 1 && val <= 31) {
                    variableExpenseCheckDay = val;
                    saveData();
                    document.getElementById('variableExpenseStatus').textContent = `現在の確認日は毎月${val}日です。`; // Corrected ID
                    alert('変動支出確認日を保存しました。');
                } else {
                    alert('1～31の範囲で入力してください。');
                }
            });

            document.getElementById('saveVariableExpenseDueDayBtn').addEventListener('click', () => {
                const val = parseInt(document.getElementById('variableExpenseDueDay').value);
                if (!isNaN(val) && val >= 1 && val <= 31) {
                    variableExpenseDueDay = val;
                    localStorage.setItem('variableExpenseDueDay', val);
                    document.getElementById('variableExpenseStatus').textContent = `現在の発生日は毎月${val}日です。`;
                    alert('変動支出の発生日を保存しました。');
                } else {
                    alert('1～31の範囲で入力してください。');
                }
            });

            const container = document.getElementById('split-items-container');
            addSplitItemRow(container);
            updateSplitTotal();
            document.getElementById('date').valueAsDate = new Date();
            
            addFixedExpensesForMonth(currentMonth); // 初期読み込み時に固定費をチェック
            addVariableExpensesForMonth(currentMonth); // 初期読み込み時に変動費をチェック (added)
            switchTab('home');
            renderApp();
        });

        function editTransaction(timestamp) {
            const transaction = transactions.find(t => t.timestamp === timestamp);
            if (!transaction) return;

            // モーダルを表示
            document.getElementById('editTransactionModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';

            // フォームにデータをセット
            document.getElementById('editDate').value = transaction.date || '';
            document.getElementById('editPlace').value = transaction.place || '';
            document.getElementById('editAmount').value = transaction.amount || 0;
            document.getElementById('editMemo').value = transaction.memo || '';
            document.getElementById('editTags').value = transaction.tags || '';

            // ジャンルセレクトボックスを更新
            const genreSelect = document.getElementById('editGenre');
            genreSelect.innerHTML = '';
            genres.forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                if (g.name === transaction.genre) option.selected = true;
                genreSelect.appendChild(option);
            });

            // 保存ボタンの動作を設定
            const form = document.getElementById('editTransactionForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                saveEditedTransaction(timestamp);
            };

            // キャンセルボタンの動作を設定
            document.getElementById('cancelEditBtn').onclick = () => {
                document.getElementById('editTransactionModal').style.display = 'none';
                document.getElementById('modalOverlay').style.display = 'none';
            };
        }

        function saveEditedTransaction(timestamp) {
            const transaction = transactions.find(t => t.timestamp === timestamp);
            if (!transaction) return;

            // フォームのデータを取得
            transaction.date = document.getElementById('editDate').value;
            transaction.place = document.getElementById('editPlace').value;
            transaction.amount = parseInt(document.getElementById('editAmount').value);

            // データを保存してUIを更新
            saveData();
            renderApp();

            // モーダルを閉じる
            document.getElementById('editTransactionModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';

            alert('履歴を更新しました。');
        }

        function openEditGenreModal(index) {
            const genre = genres[index];
            if (!genre) return;

            // モーダルを表示
            document.getElementById('editGenreModal').style.display = 'block';
            document.getElementById('editGenreOverlay').style.display = 'block';

            // フォームにデータをセット
            document.getElementById('editGenreName').value = genre.name || '';
            document.getElementById('editGenreType').value = genre.type || '';
            document.getElementById('editGenreDueDay').value = genre.dueDay || '';

            // 保存ボタンの動作を設定
            const form = document.getElementById('editGenreForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                saveEditedGenre(index);
            };

            // キャンセルボタンの動作を設定
            document.getElementById('cancelEditGenreBtn').onclick = () => {
                document.getElementById('editGenreModal').style.display = 'none';
                document.getElementById('editGenreOverlay').style.display = 'none';
            };
        }

        function saveEditedGenre(index) {
            const genre = genres[index];
            if (!genre) return;

            const oldName = genre.name;
            const newName = document.getElementById('editGenreName').value.trim();
            const newType = document.getElementById('editGenreType').value;
            const newDueDay = parseInt(document.getElementById('editGenreDueDay').value) || null;

            // データを更新
            genre.name = newName;
            genre.type = newType;
            genre.dueDay = newDueDay;

            // 関連データを更新
            transactions.forEach(t => {
                if (t.genre === oldName) t.genre = newName;
            });

            Object.keys(budgetsByMonth).forEach(month => {
                if (budgetsByMonth[month][oldName]) {
                    budgetsByMonth[month][newName] = budgetsByMonth[month][oldName];
                    delete budgetsByMonth[month][oldName];
                }
            });

            // データを保存してUIを更新
            saveData();
            renderApp();

            // モーダルを閉じる
            document.getElementById('editGenreModal').style.display = 'none';
            document.getElementById('editGenreOverlay').style.display = 'none';

            alert('ジャンルを更新しました。');
        }
    </script>
</body>
</html>
