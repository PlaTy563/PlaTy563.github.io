<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‹ã‚‚ã®ã¯ã—å®¶è¨ˆç°¿</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // GoogleGenerativeAIã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <script>
        // gapiLoadedã¨gisLoadedã¯onloadå±æ€§ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©
        let tokenClient, gapiInited = false, gsiInited = false, backupFileId = null;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // callback will be set dynamically
            });
            gsiInited = true;
            maybeInitAuth();
        }

        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            maybeInitAuth();
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        :root{--primary-color:#2e7d32;--primary-dark-variant:#266b2a;--primary-light-variant:#5cb85c;--background-light:#f8f8f8;--card-bg-light:#fff;--text-color-light:#333;--border-color-light:#e0e0e0}
        *,*::before,*::after{box-sizing:border-box}
        body{margin:0;font-family:'Noto Sans JP',sans-serif;padding-bottom:90px;background-color:var(--background-light);color:var(--text-color-light)}
        @media (prefers-color-scheme:dark){:root{--background-light:#121212;--card-bg-light:#1e1e1e;--text-color-light:#e0e0e0;--border-color-light:#444}}
        header{display:flex;align-items:center;padding:1rem;background-color:var(--primary-dark-variant);color:#fff;width:100%;max-width:48rem;margin:0 auto;box-shadow:0 4px 6px rgba(0,0,0,.1);border-bottom-left-radius:.75rem;border-bottom-right-radius:.75rem}
        header img{width:64px;height:64px;margin-right:1rem}
        header h1{font-size:1.75rem;font-weight:700;margin:0}
        main{display:flex;flex-direction:column;align-items:center;width:100%;max-width:48rem;margin:2rem auto;padding:0 1rem}
        section{background-color:var(--card-bg-light);padding:1.5rem;border-radius:.75rem;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:1.5rem;width:100%}
        h2{font-size:1.25rem;font-weight:700;margin-top:0;margin-bottom:1rem}
        .tab-buttons{position:fixed;bottom:0;left:0;right:0;background-color:var(--primary-dark-variant);box-shadow:0 -4px 6px rgba(0,0,0,.1);display:flex;justify-content:space-around;padding:.75rem;z-index:10}
        .tab-buttons button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.5rem 0;border:none;background-color:transparent;color:#fff;font-size:.75rem;border-radius:.5rem;transition:background-color .2s}
        .tab-buttons button.active{background-color:var(--primary-light-variant)}
        .tab-buttons button span{font-size:1.5rem;line-height:1}
        form input,form select,form button{width:100%;padding:.75rem;border-radius:.5rem;border:1px solid var(--border-color-light);font-size:1rem;margin-bottom:.75rem}
        button{background-color:var(--primary-color);color:#fff;font-weight:700;border:none;cursor:pointer;transition:background-color .2s;border-radius:.5rem;padding:.75rem 1rem}
        button:hover{background-color:var(--primary-light-variant)}
        .split-item-row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}.split-item-row select,.split-item-row input{flex:1}
        .split-item-row button{flex-shrink:0;width:auto;padding:.5rem .75rem;font-size:1rem;line-height:1;background-color:#ef4444}
        #total-split-amount{font-size:1.25rem;font-weight:700;text-align:right;margin-top:1rem;color:var(--primary-dark-variant)}
        table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.875rem}th,td{padding:.75rem .5rem;border:1px solid var(--border-color-light);text-align:center}
        tr.split-group-start > td{border-top:2px solid var(--primary-color) !important}
        tr.split-child > td{border-top:1px dashed #ccc !important}
        .split-child .split-info-cell{color:#9ca3af}
        .calendar-grid-container{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center}.calendar-day-header{font-weight:700;font-size:.8rem;padding-bottom:4px}.calendar-day-cell{border:1px solid var(--border-color-light);border-radius:.5rem;padding:4px;min-height:60px;display:flex;flex-direction:column;align-items:center;font-size:.8rem}.calendar-expense-amount{font-size:.7rem;color:red;font-weight:700;margin-top:4px}
        .scroll-table{overflow-x:auto}
        button, input, select { min-height: 48px; font-size: 1.1rem; }
        .tab-buttons button { min-height: 48px; font-size: 1rem; }
        input[type="date"], input[type="number"], input[type="text"], select { font-size: 1.1rem; padding: 0.75rem 0.5rem; }
        @media (max-width: 600px) {
            main, section { padding: 0.5rem; }
            h1, h2 { font-size: 1.1rem; }
            table th, table td { font-size: 0.95rem; padding: 0.5rem 0.25rem; }
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .custom-modal-content {
            background: var(--card-bg-light);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 90%;
            width: 350px;
            color: var(--text-color-light);
        }
        .custom-modal-content h3 {
            margin-top: 0;
            color: var(--primary-dark-variant);
        }
        .custom-modal-content p {
            margin-bottom: 20px;
        }
        .custom-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .custom-modal-buttons button {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        .custom-modal-buttons .confirm-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
        }
        .custom-modal-buttons .confirm-btn:hover {
            background-color: var(--primary-light-variant);
        }
        .custom-modal-buttons .cancel-btn {
            background-color: #ccc;
            color: #333;
            border: none;
        }
        .custom-modal-buttons .cancel-btn:hover {
            background-color: #bbb;
        }
        .custom-modal-buttons .alert-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            width: 100%;
        }
        .custom-modal-buttons .alert-btn:hover {
            background-color: var(--primary-light-variant);
        }

        /* æ–°ã—ã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .scroll-graph-container {
            overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
            width: 100%; /* è¦ªè¦ç´ ã®å¹…ã«åˆã‚ã›ã‚‹ */
            padding-bottom: 15px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãŸã‚ã®ä½™ç™½ */
        }
        .scroll-graph-container canvas {
            display: block; /* ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’ãªãã™ */
            height: 300px; /* ã‚°ãƒ©ãƒ•ã®é«˜ã•ã¯å›ºå®š */
            /* widthã¯JSã§å‹•çš„ã«è¨­å®šã•ã‚Œã‚‹ */
        }

    </style>
</head>
<body>
    <header>
        <img src="icon-512.png" alt="ã‹ã‚‚ã®ã¯ã—å®¶è¨ˆç°¿ãƒ­ã‚´">
        <h1>ã‹ã‚‚ã®ã¯ã—å®¶è¨ˆç°¿</h1>
    </header>
    <main id="mainContent">
        <div id="homeSection">
             <section>
                <h2><span style="font-size:1.5rem;margin-right:8px;">ğŸ“·</span>ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•å…¥åŠ› (OCR)</h2>
                <input type="file" id="receipt-uploader" accept="image/*" capture="environment">
                <button id="process-receipts-btn" style="margin-top:0.5rem;">é¸æŠã—ãŸãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿å–ã‚‹</button>
                <div id="ocr-status" style="text-align:center;margin-top:1rem;font-weight:bold;"></div>
                <div id="ocr-results" style="margin-top:1rem;display:flex;flex-direction:column;gap:8px;"></div>
            </section>
            <section>
                <h2>æ”¯å‡ºãƒ»åå…¥ã®è¨˜éŒ²</h2>
                <form id="recordForm">
                    <div style="display:flex;gap:1rem;"><input type="date" id="date" required><select id="type"><option value="expense">æ”¯å‡º</option><option value="income">åå…¥</option></select></div>
                    <input type="text" id="place" placeholder="å ´æ‰€ï¼ˆä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼Aï¼‰" required>
                    <div id="split-items-container" class="space-y-2 border-t border-b py-4 my-2"></div>
                    <button type="button" id="add-split-item-btn" style="background-color:#e5e7eb;color:#1f2937;">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>
                    <div id="total-split-amount">åˆè¨ˆ: Â¥0</div>
                    <input type="text" id="tags" placeholder="ã‚¿ã‚°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã«é©ç”¨ï¼‰">
                    <input type="text" id="memo" placeholder="å‚™è€ƒï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã«é©ç”¨ï¼‰">
                    <button type="submit">è¨˜éŒ²</button>
                </form>
            </section>
            <section>
                <h2>
                    <input type="month" id="monthSelector" style="font-size:1.25rem;border:none;padding-left:0;width:auto;">ã®çŠ¶æ³
                </h2>
                <div id="budgetSortControls" style="display:flex; gap: 8px; margin-bottom: 1rem; align-items: center;">
                    <label for="budgetSortBy" style="font-size: 0.9rem; margin-right: 4px;">ä¸¦ã¹æ›¿ãˆ:</label>
                    <select id="budgetSortBy" style="flex: 1; padding: 0.5rem; font-size: 0.9rem; min-height: unset; margin-bottom: 0;">
                        <option value="genre">ã‚¸ãƒ£ãƒ³ãƒ«</option>
                        <option value="budget">äºˆç®—</option>
                        <option value="spent">æ”¯å‡º</option>
                        <option value="remaining">æ®‹é¡</option>
                    </select>
                    <button id="budgetSortDirection" style="width: auto; padding: 0.5rem 0.75rem; font-size: 0.9rem; min-height: unset; margin-bottom: 0;">â–²</button>
                </div>
                <div id="budgetTableArea" style="margin-bottom:1rem;"></div>
                 <div id="budgetProgressBars" style="margin-top:1.5rem;"></div>
                <div class="calendar-grid-container" style="margin-top:1.5rem;"></div>
            </section>
            <section>
              <h2>å£åº§æ®‹é«˜</h2>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" id="accountBalanceInput" placeholder="ç¾åœ¨ã®å£åº§æ®‹é«˜" style="flex:1;">
                <button id="saveAccountBalanceBtn" style="width:auto;">ä¿å­˜</button>
              </div>
              <div id="balanceGraphArea" style="margin:1rem 0;"></div>
            </section>
            <section>
                    <h2>å ´æ‰€åˆ¥æ”¯å‡º</h2>
                <div style="display:flex; gap: 8px; margin-bottom: 1rem; align-items: center;">
                    <label for="spendingPlaceLimit" style="font-size: 0.9rem; margin-right: 4px;">è¡¨ç¤ºé …ç›®æ•°:</label>
                    <input type="number" id="spendingPlaceLimit" value="10" min="1" style="flex: 1; padding: 0.5rem; font-size: 0.9rem; min-height: unset; margin-bottom: 0;">
                    <button id="updateSpendingPlaceGraphBtn" style="width: auto; padding: 0.5rem 0.75rem; font-size: 0.9rem; min-height: unset; margin-bottom: 0;">æ›´æ–°</button>
                </div>
                <div id="spendingByPlaceGraphArea" style="margin:1rem 0;"></div>
            </section>
            <section>
                <h2>è²¡å‹™å¥å…¨æ€§ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
                <div style="display:flex; justify-content:center; align-items:center; flex-direction:column; margin-bottom:1rem;">
                    <div id="financialHealthScoreDisplay" style="font-size:3rem; font-weight:bold; color:var(--primary-color);">--</div>
                    <p style="font-size:0.9rem; color:#666;">ï¼ˆä»Šæœˆã®è²¡å‹™å¥å…¨æ€§ã‚¹ã‚³ã‚¢ï¼‰</p>
                </div>
                <div id="financialHealthInsights" style="background-color:var(--background-light); padding:1rem; border-radius:.5rem;">
                    <p style="text-align:center; color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </section>
            <section>
                <h2>å±¥æ­´</h2>
                 <button id="monthlyReportBtn" style="margin-bottom:1rem;">ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹</button>
                <div id="monthlyReportArea" style="margin-top:1rem; margin-bottom:1rem;"></div>
                <div class="scroll-table"><table><thead><tr><th>æ—¥ä»˜</th><th>å ´æ‰€</th><th>é‡‘é¡</th><th>ã‚¸ãƒ£ãƒ³ãƒ«</th><th>ãƒ¡ãƒ¢</th><th>ã‚¿ã‚°</th><th>æ“ä½œ</th></tr></thead><tbody id="historyBody"></tbody></table></div>
            </section>
        </div>
        <div id="settingsSection" style="display:none;">
            <section>
                <h2>Google Drive ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
                <div id="auth-status" style="margin-bottom:1rem;font-weight:bold;">åˆæœŸåŒ–ä¸­...</div>
                <div style="display:flex;gap:8px;">
                    <button id="authorize_button" style="background-color:#4285F4;visibility:hidden;">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                    <button id="signout_button" style="display:none;background-color:#db4437;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button id="backup_button" disabled>Driveã¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                    <button id="restore_button" disabled>Driveã‹ã‚‰å¾©å…ƒ</button>
                </div>
                <div id="backup-status" style="text-align:center;margin-top:1rem;"></div>
            </section>
            <section>
                <h2>ã‚¸ãƒ£ãƒ³ãƒ«ã®ç®¡ç†</h2>
                <div style="display:flex;gap:8px;">
                    <input type="text" id="newGenre" placeholder="æ–°ã—ã„ã‚¸ãƒ£ãƒ³ãƒ«å">
                    <select id="newGenreType">
                        <option value="">é€šå¸¸</option>
                        <option value="fixed">å®šæœŸï¼ˆå›ºå®šï¼‰</option>
                        <option value="variable">å®šæœŸï¼ˆå¤‰å‹•ï¼‰</option>
                    </select>
                    <input type="number" id="newGenreDueDay" min="1" max="31" placeholder="ç™ºç”Ÿæ—¥ (ä»»æ„)">
                    <button id="addGenreBtn" style="width:auto;flex-shrink:0;">è¿½åŠ </button>
                </div>
                <div id="genreList" style="margin-top:1rem;"></div>
            </section>
            <section>
                <h2>äºˆç®—ã®è¨­å®š</h2>
                <div style="display:flex;gap:8px;"><select id="budgetGenre" style="flex:1;"></select><input type="number" id="budgetAmount" placeholder="é‡‘é¡" style="flex:1;"><button id="setBudgetBtn" style="width:auto;flex-shrink:0;">è¨­å®š</button></div>
                <button id="copyBudgetBtn" style="width:100%;margin-top:8px;">å…ˆæœˆã®äºˆç®—ã‚’ã‚³ãƒ”ãƒ¼</button>
            </section>
            <section>
                <h2>å®šæœŸçš„ãªå–å¼•ã®ç®¡ç†</h2>
                <p style="font-size:0.9rem;color:#666;margin-bottom:1rem;">
                    ã€Œå®šæœŸï¼ˆå›ºå®šï¼‰ã€ã¾ãŸã¯ã€Œå®šæœŸï¼ˆå¤‰å‹•ï¼‰ã€ã«è¨­å®šã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«ã¯ã€æ¯æœˆè‡ªå‹•çš„ã«å–å¼•ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚<br>
                    ç™ºç”Ÿæ—¥ã¯å„ã‚¸ãƒ£ãƒ³ãƒ«ã§è¨­å®šã•ã‚ŒãŸæ—¥ä»˜ãŒå„ªå…ˆã•ã‚Œã€æœªè¨­å®šã®å ´åˆã¯ã€Œå¤‰å‹•æ”¯å‡ºã®ç™ºç”Ÿæ—¥ã€ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚
                </p>
                <button id="generateRecurringTransactionsBtn" style="margin-bottom:1rem;">ä»Šæœˆã®å®šæœŸå–å¼•ã‚’ç”Ÿæˆ</button>
                <div id="recurringTransactionsList" style="margin-top:1rem;"></div>
            </section>
            <section>
                <h2>Gemini API ã‚­ãƒ¼è¨­å®š</h2>
                <input type="password" id="apiKeyInput" placeholder="ã“ã“ã«Gemini APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘">
                <button id="saveApiKeyBtn" style="margin-top:0.5rem;">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
            </section>
            <section>
                <h2>ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                <button id="exportDataBtn">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <input type="file" id="importFileInput" style="display:none;" accept=".json">
                <button id="importDataButton" style="margin-top:8px;">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </section>
            <section>
                <h2>å¤‰å‹•æ”¯å‡ºç¢ºèªæ—¥ã¨ç™ºç”Ÿæ—¥</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="number" id="variableExpenseCheckDay" min="1" max="31" placeholder="ç¢ºèªæ—¥ (æ¯æœˆ)" style="flex:1;">
                    <button id="saveVariableExpenseCheckDayBtn" style="width:auto;">ä¿å­˜</button>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                    <input type="number" id="variableExpenseDueDay" min="1" max="31" placeholder="ç™ºç”Ÿæ—¥ (æ¯æœˆ)" style="flex:1;">
                    <button id="saveVariableExpenseDueDayBtn" style="width:auto;">ä¿å­˜</button>
                </div>
                <div id="variableExpenseStatus" style="margin-top:0.5rem;color:#666;font-size:0.95rem;"></div>
            </section>
        </div>
    </main>
    <div class="tab-buttons">
        <button id="homeTab" class="active"><span>ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
        <button id="settingsTab"><span>âš™ï¸</span>è¨­å®š</button>
    </div>

    <!-- å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editTransactionModal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#fff;padding:1rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:1000;">
        <h2>å±¥æ­´ã®ç·¨é›†</h2>
        <form id="editTransactionForm">
            <label>æ—¥ä»˜: <input type="date" id="editDate" required></label><br>
            <label>å ´æ‰€: <input type="text" id="editPlace" required></label><br>
            <label>é‡‘é¡: <input type="number" id="editAmount" required></label><br>
            <label>ã‚¸ãƒ£ãƒ³ãƒ«: 
                <select id="editGenre"></select>
            </label><br>
            <label>ãƒ¡ãƒ¢: <input type="text" id="editMemo"></label><br>
            <label>ã‚¿ã‚°: <input type="text" id="editTags"></label><br>
            <button type="submit">ä¿å­˜</button>
            <button type="button" id="cancelEditBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </form>
    </div>
    <div id="modalOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;"></div>
    
    <!-- ã‚¸ãƒ£ãƒ³ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editGenreModal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#fff;padding:1rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:1000;">
        <h2>ã‚¸ãƒ£ãƒ³ãƒ«ã®ç·¨é›†</h2>
        <form id="editGenreForm">
            <label>ã‚¸ãƒ£ãƒ³ãƒ«å: <input type="text" id="editGenreName" required></label><br>
            <label>ã‚¸ãƒ£ãƒ³ãƒ«ã‚¿ã‚¤ãƒ—: 
                <select id="editGenreType">
                    <option value="">é€šå¸¸</option>
                    <option value="fixed">å®šæœŸï¼ˆå›ºå®šï¼‰</option>
                    <option value="variable">å®šæœŸï¼ˆå¤‰å‹•ï¼‰</option>
                </select>
            </label><br>
            <label>ç™ºç”Ÿæ—¥: <input type="number" id="editGenreDueDay" min="1" max="31" placeholder="ç™ºç”Ÿæ—¥ (ä»»æ„)"></label><br>
            <button type="submit">ä¿å­˜</button>
            <button type="button" id="cancelEditGenreBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </form>
    </div>
    <div id="editGenreOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;"></div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ/ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="customAlertModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3 id="customAlertTitle"></h3>
            <p id="customAlertMessage"></p>
            <div class="custom-modal-buttons">
                <button class="alert-btn" id="customAlertOk">OK</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3 id="customConfirmTitle"></h3>
            <p id="customConfirmMessage"></p>
            <div class="custom-modal-buttons">
                <button class="confirm-btn" id="customConfirmYes">ã¯ã„</button>
                <button class="cancel-btn" id="customConfirmNo">ã„ã„ãˆ</button>
            </div>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="importOptionsModal" class="custom-modal-overlay">
        <div class="custom-modal-content" style="max-width: 450px;">
            <h3 id="importOptionsTitle">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
            <p>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚é¸æŠã—ãªã„é …ç›®ã¯ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¾ã™ã€‚</p>
            <div style="text-align: left; margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px;">
                    <input type="checkbox" id="importTransactions" checked> å±¥æ­´ (<span id="importTransactionsCount">0</span>ä»¶)
                </label>
                <label style="display: block; margin-bottom: 8px;">
                    <input type="checkbox" id="importGenres" checked> ã‚¸ãƒ£ãƒ³ãƒ« (<span id="importGenresCount">0</span>ä»¶)
                </label>
                <label style="display: block; margin-bottom: 8px;">
                    <input type="checkbox" id="importBudgets" checked> äºˆç®— (<span id="importBudgetsCount">0</span>ãƒ¶æœˆåˆ†)
                </label>
                <label style="display: block;">
                    <input type="checkbox" id="importRolloverGenres" checked> ç¹°è¶Šã‚¸ãƒ£ãƒ³ãƒ« (<span id="importRolloverGenresCount">0</span>ä»¶)
                </label>
                <label style="display: block;">
                    <input type="checkbox" id="importPlaceGenreMap" checked> å ´æ‰€åˆ¥ã‚¸ãƒ£ãƒ³ãƒ«å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ (<span id="importPlaceGenreMapCount">0</span>ä»¶)
                </label>
            </div>
            <div class="custom-modal-buttons">
                <button class="confirm-btn" id="importOptionsProceed">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="cancel-btn" id="importOptionsCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let transactions = [];
        let genres = [
          { name: 'é£Ÿè²»', type: '' },
          { name: 'å®¶è³ƒ', type: 'fixed' },
          { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰', type: 'variable' },
        ];
        let budgetsByMonth = {};
        let rolloverGenres = [];
        let currentMonth = new Date().toISOString().slice(0, 7);
        let budgetPieChart = null;
        let accountBalance = 0;
        let variableExpenseCheckDay = 1;
        let variableExpenseDueDay = 1; // Added initialization for variableExpenseDueDay
        const LOCAL_STORAGE_KEY = 'kakeiboData';
        const PLACE_GENRE_MAP_KEY = 'placeGenreMap'; // å ´æ‰€ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã®é–¢é€£æ€§ã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ¼
        let spendingByPlaceChart = null; // å ´æ‰€åˆ¥æ”¯å‡ºã‚°ãƒ©ãƒ•ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let placeGenreMap = {}; // å ´æ‰€ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã®é–¢é€£æ€§ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let budgetSortColumn = 'genre'; // Default sort column
        let budgetSortDirection = 'asc'; // Default sort direction
        let spendingPlaceLimit = 3; // å ´æ‰€åˆ¥æ”¯å‡ºã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºé …ç›®æ•°

        // --- Google Drive APIé–¢é€£ ---
        const API_KEY = 'AIzaSyA8SHDfUl1CWayCmq6oGREjnxWR6R8vPkM'; // â˜…GitHubã«ä¸Šã’ã‚‹éš›ã¯å¿…ãšãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«æˆ»ã™ã“ã¨ï¼
        const CLIENT_ID = '98738563895-d80ev131bgogmct7hi0qv3ojopu52dsj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const BACKUP_FILENAME = 'kakeibo_backup.json';
        // tokenClient, gapiInited, gsiInited, backupFileId ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©æ¸ˆã¿

        // --- Google APIåˆæœŸåŒ–ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ (ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç§»å‹•) ---
        // gapiLoaded, gisLoaded, initializeGapiClient ã¯HTMLã®headå†…ã®scriptã‚¿ã‚°ã§å®šç¾©æ¸ˆã¿
        // window.gapiLoaded = function() { ... } ã¨ window.gisLoaded = function() { ... } ã¯å‰Šé™¤æ¸ˆã¿

        function maybeInitAuth() {
            const authStatus = document.getElementById('auth-status');
            if (gapiInited && gsiInited) {
                authStatus.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                document.getElementById('authorize_button').style.visibility = 'visible';
                if (localStorage.getItem('google_auth_loggedin') === 'true') {
                   handleAuthClick(true);
                }
            }
        }

        // --- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ---
        function showAlert(message, title = 'ãŠçŸ¥ã‚‰ã›') {
            const modal = document.getElementById('customAlertModal');
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            modal.style.display = 'flex';
            return new Promise(resolve => {
                document.getElementById('customAlertOk').onclick = () => {
                    modal.style.display = 'none';
                    resolve();
                };
            });
        }

        function showConfirm(message, title = 'ç¢ºèª') {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmMessage').textContent = message;
            modal.style.display = 'flex';
            return new Promise(resolve => {
                document.getElementById('customConfirmYes').onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
                document.getElementById('customConfirmNo').onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        }

        function showImportOptionsModal(importedData) {
            const modal = document.getElementById('importOptionsModal');
            document.getElementById('importTransactionsCount').textContent = importedData.transactions ? importedData.transactions.length : 0;
            document.getElementById('importGenresCount').textContent = importedData.genres ? importedData.genres.length : 0;
            document.getElementById('importBudgetsCount').textContent = importedData.budgetsByMonth ? Object.keys(importedData.budgetsByMonth).length : 0;
            document.getElementById('importRolloverGenresCount').textContent = importedData.rolloverGenres ? importedData.rolloverGenres.length : 0;
            document.getElementById('importPlaceGenreMapCount').textContent = importedData.placeGenreMap ? Object.keys(importedData.placeGenreMap).length : 0; // æ–°ã—ã„ã‚«ã‚¦ãƒ³ãƒˆ

            document.getElementById('importTransactions').checked = !!importedData.transactions;
            document.getElementById('importGenres').checked = !!importedData.genres;
            document.getElementById('importBudgets').checked = !!importedData.budgetsByMonth;
            document.getElementById('importRolloverGenres').checked = !!importedData.rolloverGenres;
            document.getElementById('importPlaceGenreMap').checked = !!importedData.placeGenreMap; // æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

            modal.style.display = 'flex';

            return new Promise(resolve => {
                document.getElementById('importOptionsProceed').onclick = () => {
                    const selections = {
                        transactions: document.getElementById('importTransactions').checked,
                        genres: document.getElementById('importGenres').checked,
                        budgetsByMonth: document.getElementById('importBudgets').checked,
                        rolloverGenres: document.getElementById('importRolloverGenres').checked,
                        placeGenreMap: document.getElementById('importPlaceGenreMap').checked // æ–°ã—ã„é¸æŠé …ç›®
                    };
                    modal.style.display = 'none';
                    resolve(selections);
                };
                document.getElementById('importOptionsCancel').onclick = () => {
                    modal.style.display = 'none';
                    resolve(null); // User cancelled
                };
            });
        }


        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }

        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!storedData) return;
            const data = JSON.parse(storedData);
            transactions = data.transactions || [];
            genres = data.genres || [ { name: 'é£Ÿè²»', type: '' }, { name: 'å®¶è³ƒ', type: 'fixed' }, { name: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰', type: 'variable' } ];
            budgetsByMonth = data.budgetsByMonth || data.budgets || {};
            rolloverGenres = data.rolloverGenres || [];
            accountBalance = parseInt(localStorage.getItem('accountBalance') || '0');
            variableExpenseCheckDay = parseInt(localStorage.getItem('variableExpenseCheckDay') || '1');
            variableExpenseDueDay = parseInt(localStorage.getItem('variableExpenseDueDay') || '1');
            
            // å ´æ‰€ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã®é–¢é€£æ€§ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€
            const storedPlaceGenreMap = localStorage.getItem(PLACE_GENRE_MAP_KEY);
            if (storedPlaceGenreMap) {
                placeGenreMap = JSON.parse(storedPlaceGenreMap);
            }
        }

        function saveData() {
            const dataToSave = { transactions, genres, budgetsByMonth, rolloverGenres, placeGenreMap }; // placeGenreMapã‚‚ä¿å­˜
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            localStorage.setItem('accountBalance', accountBalance);
            localStorage.setItem('variableExpenseCheckDay', variableExpenseCheckDay);
            localStorage.setItem('variableExpenseDueDay', variableExpenseDueDay);
            // å ´æ‰€ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã®é–¢é€£æ€§ãƒãƒƒãƒ—ã‚’ä¿å­˜ã™ã‚‹
            localStorage.setItem(PLACE_GENRE_MAP_KEY, JSON.stringify(placeGenreMap));
        }

        // --- UIæ›´æ–° ---
        function renderApp() {
            document.getElementById('monthSelector').value = currentMonth;
            document.getElementById('accountBalanceInput').value = accountBalance || '';
            document.getElementById('variableExpenseCheckDay').value = variableExpenseCheckDay || '';
            document.getElementById('variableExpenseDueDay').value = variableExpenseDueDay || '';
            document.getElementById('variableExpenseStatus').textContent = `å¤‰å‹•æ”¯å‡ºã®ç™ºç”Ÿæ—¥ã¯ã€å„ã‚¸ãƒ£ãƒ³ãƒ«ã§è¨­å®šã•ã‚ŒãŸæ—¥ä»˜ï¼ˆæœªè¨­å®šã®å ´åˆã¯æ¯æœˆ${variableExpenseDueDay}æ—¥ï¼‰ã§ã™ã€‚`;

            updateHistoryTable();
            updateGenreManagementList();
            updateBudgetGenreSelector();
            updateSplitItemGenreSelects();
            updateCalendarView();
            updateBudgetTable();
            updateBudgetProgressBars();
            renderBalanceGraph();
            renderSpendingByPlaceGraph(); // å ´æ‰€åˆ¥æ”¯å‡ºã‚°ãƒ©ãƒ•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderFinancialHealthSection(); // è²¡å‹™å¥å…¨æ€§ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            checkVariableExpensesIfNeeded();
            renderRecurringTransactionsList(); // æ–°ã—ã„é–¢æ•°ã‚’å‘¼ã³å‡ºã™
        }

        function switchTab(tabName) {
            document.getElementById('homeSection').style.display = (tabName === 'home' ? 'block' : 'none');
            document.getElementById('settingsSection').style.display = (tabName === 'settings' ? 'block' : 'none');
            document.getElementById('homeTab').classList.toggle('active', tabName === 'home');
            document.getElementById('settingsTab').classList.toggle('active', tabName === 'settings');
        }

        function updateGenreManagementList() {
            const genreListDiv = document.getElementById('genreList');
            genreListDiv.innerHTML = '';
            genres.forEach((g, index) => {
                const isRolloverEnabled = rolloverGenres.includes(g.name);
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:4px;border-bottom:1px solid var(--border-color-light)';
                itemDiv.setAttribute('draggable', 'true');
                itemDiv.setAttribute('data-index', index);
                itemDiv.innerHTML = `
                    <span>${g.name || ''} (${g.type || 'é€šå¸¸'})</span>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="number" class="genre-due-day" data-genre="${g.name}" value="${g.dueDay || ''}" min="1" max="31" placeholder="ç™ºç”Ÿæ—¥">
                        <label style="font-size:0.8rem;">
                            <input type="checkbox" class="rollover-checkbox" data-genre="${g.name}" ${isRolloverEnabled ? 'checked' : ''}> ç¹°è¶Š
                        </label>
                        <button class="edit-genre-btn" data-index="${index}" style="width:auto;padding:2px 6px;background-color:#4caf50;color:#fff;">ç·¨é›†</button>
                        <button class="delete-btn" data-genre="${g.name}" style="width:auto;padding:2px 6px;background-color:#ef4444;">&times;</button>
                    </div>`;
                genreListDiv.appendChild(itemDiv);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                itemDiv.querySelector('.edit-genre-btn').addEventListener('click', (e) => openEditGenreModal(e.target.dataset.index));
                itemDiv.querySelector('.delete-btn').addEventListener('click', async (e) => {
                    const confirmed = await showConfirm(`ã€Œ${e.target.dataset.genre}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
                    if (confirmed) deleteGenre(e.target.dataset.genre);
                });
                itemDiv.querySelector('.rollover-checkbox').addEventListener('change', (e) => handleRolloverChange(e.target.dataset.genre, e.target.checked));
                itemDiv.querySelector('.genre-due-day').addEventListener('change', (e) => updateGenreDueDay(e.target.dataset.genre, e.target.value));
            });
        }

        let draggedItemIndex = null;

        function handleDragStart(e) {
            draggedItemIndex = parseInt(e.target.getAttribute('data-index'));
            e.target.style.opacity = '0.5'; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’åŠé€æ˜ã«ã™ã‚‹
        }

        function handleDragOver(e) {
            e.preventDefault(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ã™ã‚‹
            e.target.style.border = '2px dashed var(--primary-color)'; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸Šã«æ ç·šã‚’è¡¨ç¤º
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetIndex = parseInt(e.target.closest('[data-index]').getAttribute('data-index'));
            if (draggedItemIndex !== null && targetIndex !== null && draggedItemIndex !== targetIndex) {
                // ã‚¸ãƒ£ãƒ³ãƒ«ã®é †åºã‚’å…¥ã‚Œæ›¿ãˆã‚‹
                const draggedItem = genres[draggedItemIndex];
                genres.splice(draggedItemIndex, 1);
                genres.splice(targetIndex, 0, draggedItem);

                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦UIã‚’æ›´æ–°
                saveData();
                updateGenreManagementList();
            }
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1'; // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã«é€æ˜åº¦ã‚’å…ƒã«æˆ»ã™
            document.querySelectorAll('[data-index]').forEach(item => {
                item.style.border = ''; // æ ç·šã‚’æ¶ˆã™
            });
        }

        function updateGenreDueDay(genreName, dueDay) {
            const genre = genres.find(g => g.name === genreName);
            if (genre) {
                genre.dueDay = parseInt(dueDay) || null;
                saveData();
            }
        }

        function updateHistoryTable() {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '';
            const filtered = transactions.filter(t => t.date && t.date.startsWith(currentMonth));
            const sorted = filtered.sort((a, b) => b.date.localeCompare(a.date) || (b.timestamp > a.timestamp ? -1 : 1));
            sorted.forEach((transaction, index) => {
                const row = historyBody.insertRow();
                let isSplitChild = transaction.splitGroupId && index > 0 && sorted[index - 1].splitGroupId === transaction.splitGroupId;
                if (transaction.splitGroupId && !isSplitChild) row.classList.add('split-group-start');
                if (isSplitChild) row.classList.add('split-child');
                const infoCell = (content) => isSplitChild ? `<span class="split-info-cell">${content || ''}</span>` : `<span>${content || ''}</span>`;
                row.innerHTML = `
                    <td>${infoCell(transaction.date || '')}</td>
                    <td>${infoCell(transaction.place || '')}</td>
                    <td style="color:${transaction.type === 'expense' ? 'red' : 'green'};">${new Intl.NumberFormat().format(transaction.amount || 0)}å††</td>
                    <td>${transaction.genre || ''}</td>
                    <td>${infoCell(transaction.memo || '')}</td>
                    <td>${infoCell(transaction.tags || '')}</td>
                    <td>
                        <button class="edit-btn" data-timestamp="${transaction.timestamp}" style="background-color:#4caf50;padding:4px 8px;width:auto;">ç·¨é›†</button>
                        <button class="delete-btn" data-timestamp="${transaction.timestamp}" style="background-color:#ef4444;padding:4px 8px;width:auto;">å‰Šé™¤</button>
                    </td>`;
                row.querySelector('.delete-btn').addEventListener('click', async (e) => {
                    const txToDelete = transactions.find(t => t.timestamp === e.target.dataset.timestamp);
                    if (!txToDelete) return;
                    let msg = 'ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ';
                    if (txToDelete.splitGroupId && transactions.filter(t => t.splitGroupId === txToDelete.splitGroupId).length > 1) {
                        msg = 'ã“ã‚Œã¯åˆ†å‰²è¨˜éŒ²ã®ä¸€éƒ¨ã§ã™ã€‚ã“ã®é …ç›®ã®ã¿å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ';
                    }
                    const confirmed = await showConfirm(msg);
                    if (confirmed) deleteTransaction(e.target.dataset.timestamp);
                });
                row.querySelector('.edit-btn').addEventListener('click', (e) => editTransaction(e.target.dataset.timestamp));
            });
        }

        function updateCalendarView() {
            const calendarContainer = document.querySelector('.calendar-grid-container');
            calendarContainer.innerHTML = '';
            const dayHeaders = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            dayHeaders.forEach(day => calendarContainer.insertAdjacentHTML('beforeend', `<div class="calendar-day-header">${day}</div>`));
            const [year, month] = currentMonth.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyTotals = {};
            transactions.filter(t => t.date && t.date.startsWith(currentMonth) && t.type === 'expense').forEach(t => {
                const day = new Date(t.date).getDate();
                dailyTotals[day] = (dailyTotals[day] || 0) + t.amount;
            });
            for (let i = 0; i < firstDay; i++) calendarContainer.insertAdjacentHTML('beforeend', '<div></div>');
            for (let day = 1; day <= daysInMonth; day++) {
                let content = `<span class="calendar-day-number">${day}</span>`;
                if (dailyTotals[day]) content += `<span class="calendar-expense-amount">${new Intl.NumberFormat().format(dailyTotals[day])}å††</span>`;
                calendarContainer.insertAdjacentHTML('beforeend', `<div class="calendar-day-cell">${content}</div>`);
            }
        }

        function updateBudgetTable() {
            const area = document.getElementById('budgetTableArea');
            const monthlyBudget = budgetsByMonth[currentMonth] || {};
            
            // äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
            const budgetData = Object.keys(monthlyBudget).map(genreName => {
                const budget = monthlyBudget[genreName];
                const spent = transactions
                    .filter(t => t.date && t.date.startsWith(currentMonth) && t.genre === genreName && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                const remaining = budget - spent;
                return { genre: genreName, budget, spent, remaining };
            });

            // ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯
            budgetData.sort((a, b) => {
                let valA, valB;
                switch (budgetSortColumn) {
                    case 'genre':
                        valA = a.genre;
                        valB = b.genre;
                        return budgetSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    case 'budget':
                        valA = a.budget;
                        valB = b.budget;
                        break;
                    case 'spent':
                        valA = a.spent;
                        valB = b.spent;
                        break;
                    case 'remaining':
                        valA = a.remaining;
                        valB = b.remaining;
                        break;
                    default:
                        return 0; // No sort
                }
                return budgetSortDirection === 'asc' ? valA - valB : valB - valA;
            });

            let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr><th>ã‚¸ãƒ£ãƒ³ãƒ«</th><th>äºˆç®—</th><th>æ”¯å‡º</th><th>æ®‹é¡</th></tr></thead><tbody>';
            budgetData.forEach(item => {
                html += `<tr>
                    <td>${item.genre}</td>
                    <td>${new Intl.NumberFormat().format(item.budget)}å††</td>
                    <td>${new Intl.NumberFormat().format(item.spent)}å††</td>
                    <td>${new Intl.NumberFormat().format(item.remaining)}å††</td>
                </tr>`;
            });
            html += '</tbody></table>';
            area.innerHTML = html;
        }

        function updateBudgetProgressBars(){} // å®Ÿè£…ã¯çœç•¥

        function addSplitItemRow(container) {
            const row = document.createElement('div');
            row.className = 'split-item-row';
            const genreSelect = document.createElement('select');
            genreSelect.className = 'split-genre';
            updateGenreOptions(genreSelect);
            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.className = 'split-amount';
            amountInput.placeholder = 'é‡‘é¡';
            amountInput.min = '0';
            amountInput.addEventListener('input', updateSplitTotal);
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'âœ–';
            deleteBtn.addEventListener('click', () => { if (container.querySelectorAll('.split-item-row').length > 1) { row.remove(); updateSplitTotal(); }});
            row.appendChild(genreSelect);
            row.appendChild(amountInput);
            row.appendChild(deleteBtn);
            container.appendChild(row);
        }

        function updateGenreOptions(selectElement) {
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            genres.forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                selectElement.appendChild(option);
            });
            if(currentVal) selectElement.value = currentVal;
        }

        function updateSplitItemGenreSelects() { document.querySelectorAll('.split-genre').forEach(updateGenreOptions); }

        function updateSplitTotal() {
            const container = document.getElementById('split-items-container');
            const amounts = Array.from(container.querySelectorAll('.split-amount'));
            const total = amounts.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            document.getElementById('total-split-amount').textContent = `åˆè¨ˆ: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(total)}`;
        }

        async function handleRecordSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('date').value,
                place = document.getElementById('place').value,
                type = document.getElementById('type').value,
                memo = document.getElementById('memo').value,
                tags = document.getElementById('tags').value,
                splitItems = document.querySelectorAll('.split-item-row');
            if (!place) { await showAlert('å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            const splitGroupId = generateUniqueId();
            let recordsToAdd = [];
            splitItems.forEach(item => {
                const genre = item.querySelector('.split-genre').value;
                const amount = parseInt(item.querySelector('.split-amount').value);
                if (genre && amount > 0) {
                    recordsToAdd.push({ date, place, type, memo, tags, genre, amount, splitGroupId, timestamp: generateUniqueId() });
                    // å ´æ‰€ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã®é–¢é€£æ€§ã‚’å­¦ç¿’
                    if (placeGenreMap[place]) {
                        placeGenreMap[place][genre] = (placeGenreMap[place][genre] || 0) + 1;
                    } else {
                        placeGenreMap[place] = { [genre]: 1 };
                    }
                }
            });
            if (recordsToAdd.length > 0) {
                transactions.push(...recordsToAdd);
                saveData();
                renderApp();
                document.getElementById('recordForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                const container = document.getElementById('split-items-container');
                container.innerHTML = '';
                addSplitItemRow(container);
                updateSplitTotal();
            } else {
                await showAlert('æœ‰åŠ¹ãªé‡‘é¡ã‚’æŒã¤é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        }

        function deleteTransaction(timestamp) {
            transactions = transactions.filter(t => t.timestamp !== timestamp);
            saveData();
            renderApp();
        }

        async function addGenre() {
            const newGenreInput = document.getElementById('newGenre');
            const newGenreType = document.getElementById('newGenreType').value;
            const newGenreDueDay = parseInt(document.getElementById('newGenreDueDay').value) || null;
            const newGenreName = newGenreInput.value.trim();

            if (newGenreName && !genres.some(g => g.name === newGenreName)) {
                genres.push({ name: newGenreName, type: newGenreType, dueDay: newGenreDueDay });
                saveData();
                renderApp();
                newGenreInput.value = '';
                document.getElementById('newGenreDueDay').value = '';
            } else if (genres.some(g => g.name === newGenreName)) {
                await showAlert('ãã®ã‚¸ãƒ£ãƒ³ãƒ«åã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚');
            }
        }

        function deleteGenre(genreName) {
            genres = genres.filter(g => g.name !== genreName);
            rolloverGenres = rolloverGenres.filter(g => g !== genreName);
            saveData();
            renderApp();
        }

        function updateBudgetGenreSelector() {
            const budgetGenreSelect = document.getElementById('budgetGenre');
            if(!budgetGenreSelect) return;
            budgetGenreSelect.innerHTML = '';
            genres.forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                budgetGenreSelect.appendChild(option);
            });
        }

        async function setBudget() {
             const genre = document.getElementById('budgetGenre').value;
             const amount = parseInt(document.getElementById('budgetAmount').value);
             if (genre && !isNaN(amount)) {
                if(!budgetsByMonth[currentMonth]) budgetsByMonth[currentMonth] = {};
                budgetsByMonth[currentMonth][genre] = amount;
                saveData();
                renderApp();
                await showAlert('äºˆç®—ã‚’è¨­å®šã—ã¾ã—ãŸã€‚');
             } else {
                await showAlert('ã‚¸ãƒ£ãƒ³ãƒ«ã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
             }
        }

        async function copyLastMonthBudget() {
            const date = new Date(currentMonth + '-01');
            date.setMonth(date.getMonth() - 1);
            const lastMonthKey = date.toISOString().slice(0, 7);
            if (budgetsByMonth[lastMonthKey]) {
                const confirmed = await showConfirm(`${lastMonthKey}ã®äºˆç®—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®æœˆï¼ˆ${currentMonth}ï¼‰ã®äºˆç®—ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`);
                if (confirmed) {
                    budgetsByMonth[currentMonth] = { ...budgetsByMonth[lastMonthKey] };
                    saveData();
                    renderApp();
                    await showAlert(`${lastMonthKey}ã®äºˆç®—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚`);
                }
            } else {
                await showAlert('å‰æœˆã®äºˆç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        }

        function handleRolloverChange(genre, isChecked) {
            const index = rolloverGenres.indexOf(genre);
            if (isChecked && index === -1) rolloverGenres.push(genre);
            else if (!isChecked && index > -1) rolloverGenres.splice(index, 1);
            saveData();
        }

        async function exportData() {
            const dataStr = JSON.stringify({ transactions, genres, budgetsByMonth, rolloverGenres, placeGenreMap }, null, 2); // placeGenreMapã‚‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kakeibo_data_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            await showAlert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
        }

        async function importData(file) {
            if (!file) {
                await showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Show import options modal
                    const selections = await showImportOptionsModal(importedData);

                    if (selections) { // If not cancelled
                        if (selections.transactions) {
                            transactions = importedData.transactions || [];
                        }
                        if (selections.genres) {
                            genres = importedData.genres || [];
                        }
                        if (selections.budgetsByMonth) {
                            budgetsByMonth = importedData.budgetsByMonth || {};
                        }
                        if (selections.rolloverGenres) {
                            rolloverGenres = importedData.rolloverGenres || [];
                        }
                        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«placeGenreMapã‚‚æ›´æ–°
                        if (selections.placeGenreMap && importedData.placeGenreMap) { // é¸æŠã•ã‚Œã¦ã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã¦ã„ã‚Œã°
                            placeGenreMap = importedData.placeGenreMap;
                        } else if (!selections.placeGenreMap) { // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒ
                            // ä½•ã‚‚ã—ãªã„
                        } else { // é¸æŠã•ã‚ŒãŸãŒãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã¦ã„ãªã„å ´åˆ
                            placeGenreMap = {}; // ç©ºã«ã™ã‚‹ã‹ã€æ—¢å­˜ã®ã‚‚ã®ã‚’ç¶­æŒã™ã‚‹ã‹ã¯è¦ä»¶æ¬¡ç¬¬ã ãŒã€ã“ã“ã§ã¯ç©ºã«ã™ã‚‹
                        }
                        
                        saveData();
                        renderApp();
                        await showAlert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
                    } else {
                        await showAlert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
                    }
                } catch (err) {
                    console.error("Import error:", err);
                    await showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
            };
            reader.readAsText(file);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function handleReceiptProcessing() {
            const uploader = document.getElementById('receipt-uploader');
            const statusDiv = document.getElementById('ocr-status');
            const resultsDiv = document.getElementById('ocr-results');
            const processBtn = document.getElementById('process-receipts-btn');

            processBtn.disabled = true;
            processBtn.textContent = 'èª­ã¿å–ã‚Šä¸­...';

            try {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    await showAlert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œè¨­å®šã€ç”»é¢ã§APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                    switchTab('settings');
                    return;
                }

                const files = uploader.files;
                if (files.length === 0) {
                    await showAlert('ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (files.length > 1) {
                    await showAlert('è¤‡æ•°ãƒ¬ã‚·ãƒ¼ãƒˆã®ä¸€æ‹¬èª­ã¿å–ã‚Šã§ã¯ã€ä¸€åº¦ã«1æšã®ç”»åƒã®ã¿é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                statusDiv.textContent = 'å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...';
                resultsDiv.innerHTML = '';
                const SAFE_LIMIT_PER_DAY = 50;
                const today = new Date().toISOString().slice(0, 10);
                let usageCount = parseInt(localStorage.getItem(`ocrUsage_${today}`) || '0');

                if (usageCount >= SAFE_LIMIT_PER_DAY) {
                    statusDiv.textContent = `1æ—¥ã®ä¸Šé™ï¼ˆ${SAFE_LIMIT_PER_DAY}å›ï¼‰ã«é”ã—ã¾ã—ãŸã€‚`;
                    return;
                }

                const file = files[0];
                statusDiv.textContent = `${file.name} ã‚’èª­ã¿å–ã‚Šä¸­...`;

                let base64Image;
                try {
                    base64Image = await fileToBase64(file);
                } catch (fileError) {
                    console.error("OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®Base64å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", fileError);
                    await showAlert('ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'ã‚¨ãƒ©ãƒ¼');
                    return;
                }

                const genAI = new window.GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const prompt = `ã“ã®1æšã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹å…¨ã¦ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å€‹åˆ¥ã«èªè­˜ã—ã€å„ãƒ¬ã‚·ãƒ¼ãƒˆã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã€å¿…ãšJSONã®é…åˆ—ï¼ˆãƒªã‚¹ãƒˆï¼‰å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚- place: åº—å (æ–‡å­—åˆ—) - date: æ—¥ä»˜ (YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—) - total: åˆè¨ˆé‡‘é¡ (æ•°å€¤)`;
                const imagePart = { inlineData: { data: base64Image, mimeType: file.type } };
                
                let result;
                try {
                    result = await model.generateContent([prompt, imagePart]);
                } catch (apiError) {
                    console.error("OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼: Gemini APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", apiError);
                    let errorMessage = 'Gemini APIã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    if (apiError.message && apiError.message.includes('API key not valid')) {
                        errorMessage += ' APIã‚­ãƒ¼ãŒä¸æ­£ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else if (apiError.message && apiError.message.includes('quota')) {
                        errorMessage += ' APIã®ä½¿ç”¨åˆ¶é™ã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                    }
                    await showAlert(errorMessage, 'ã‚¨ãƒ©ãƒ¼');
                    return;
                }

                let responseText;
                try {
                    responseText = result.response.text().replace(/```json|```/g, '').trim();
                } catch (textError) {
                    console.error("OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚", textError);
                    await showAlert('APIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã›ã¬å½¢å¼ã§ã—ãŸã€‚', 'ã‚¨ãƒ©ãƒ¼');
                    return;
                }

                let resultsArray;
                try {
                    resultsArray = JSON.parse(responseText);
                } catch (parseError) {
                    console.error("OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼: JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:", responseText, parseError);
                    await showAlert('ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‹ã‚‰ã®å¿œç­”ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'ã‚¨ãƒ©ãƒ¼');
                    return;
                }

                if (resultsArray.length === 0) {
                    statusDiv.textContent = 'ç”»åƒã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                    await showAlert('ç”»åƒã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ˆã‚Šé®®æ˜ãªç”»åƒã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', 'æƒ…å ±');
                    return;
                }

                resultsArray.forEach(data => {
                    const card = document.createElement('div');
                    card.style.cssText = 'border: 1px solid #ccc; padding: 12px; cursor: pointer; border-radius: 8px;';
                    card.innerHTML = `<strong>åº—å:</strong> ${data.place||'ä¸æ˜'}<br><strong>æ—¥ä»˜:</strong> ${data.date||'ä¸æ˜'}<br><strong>åˆè¨ˆ:</strong> ${new Intl.NumberFormat().format(data.total||0)} å††`;
                    card.onclick = async () => {
                        document.getElementById('place').value = data.place || '';
                        if(data.date && data.date !== 'ä¸æ˜') document.getElementById('date').value = data.date;
                        const container = document.getElementById('split-items-container');
                        container.innerHTML = '';
                        addSplitItemRow(container);
                        container.querySelector('.split-amount').value = data.total || '';
                        updateSplitTotal();
                        await showAlert(`ã€Œ${data.place}ã€ã®æƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¾ã—ãŸã€‚`);
                    };
                    resultsDiv.appendChild(card);
                });
                usageCount++;
                localStorage.setItem(`ocrUsage_${today}`, usageCount);
                statusDiv.textContent = `${resultsArray.length}ä»¶ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`;

            } catch (err) {
                // ä¸Šè¨˜ã®try-catchãƒ–ãƒ­ãƒƒã‚¯ã§æ•æ‰ã•ã‚Œãªã‹ã£ãŸäºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼
                console.error("OCRå‡¦ç†ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", err);
                await showAlert('å‡¦ç†ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'ã‚¨ãƒ©ãƒ¼');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'é¸æŠã—ãŸãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿å–ã‚‹';
                uploader.value = '';
            }
        }
        
        function handleAuthClick(isSilent = false) {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { if(isSilent) return; throw (resp); }
                localStorage.setItem('google_auth_loggedin', 'true');
                document.getElementById('signout_button').style.display = 'block';
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('auth-status').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿';
                document.getElementById('backup_button').disabled = false;
                document.getElementById('restore_button').disabled = false;
                await findOrCreateBackupFile();
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: isSilent ? '' : 'consent' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('google_auth_loggedin');
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
                document.getElementById('auth-status').textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                document.getElementById('backup_button').disabled = true;
                document.getElementById('restore_button').disabled = true;
                backupFileId = null;
            }
        }

        async function findOrCreateBackupFile() { /* å®Ÿè£…ã¯çœç•¥ */ }
        async function backupToDrive() { /* å®Ÿè£…ã¯çœç•¥ */ }
        async function restoreFromDrive() { /* å®Ÿè£…ã¯çœç•¥ */ }
        
        function renderBalanceGraph() {
            const area = document.getElementById('balanceGraphArea');
            // Check if a chart already exists on the canvas and destroy it
            const existingChart = Chart.getChart("balanceTrendChart");
            if (existingChart) {
                existingChart.destroy();
            }
            area.innerHTML = '<canvas id="balanceTrendChart" style="max-width:100%;"></canvas>';
            const ctx = document.getElementById('balanceTrendChart').getContext('2d');
            const [year, month] = currentMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();

            let balanceTrend = []; // Moved this line to the top of the function.

            // æ—¥ã”ã¨ã®æ”¯å‡ºãƒ»åå…¥é›†è¨ˆ
            let dailyChange = Array(daysInMonth).fill(0);
            transactions.filter(t => t.date && t.date.startsWith(currentMonth)).forEach(t => {
                const day = new Date(t.date).getDate() - 1;
                dailyChange[day] += (t.type === 'income' ? t.amount : -t.amount);
            });

            // æ®‹é«˜æ¨ç§»è¨ˆç®— (ä¿®æ­£: åˆæ—¥ã®æ®‹é«˜ã‹ã‚‰è¨ˆç®—ã‚’é–‹å§‹)
            let startingBalanceForMonth = accountBalance;
            // å½“æœˆã‚ˆã‚Šå‰ã®å–å¼•ã®å·®é¡ã‚’è¨ˆç®—
            transactions.filter(t => t.date && t.date < `${currentMonth}-01`).forEach(t => {
                startingBalanceForMonth += (t.type === 'income' ? t.amount : -t.amount);
            });

            let currentDayBalance = startingBalanceForMonth;
            for (let i = 0; i < daysInMonth; i++) {
                currentDayBalance += dailyChange[i];
                balanceTrend.push(currentDayBalance);
            }

            // Yè»¸ã®æœ€å°å€¤ã¨æœ€å¤§å€¤ã‚’è¨ˆç®—
            let minBalance;
            let maxBalance; 

            if (balanceTrend.length > 0) {
                minBalance = Math.min(...balanceTrend, startingBalanceForMonth);
                maxBalance = Math.max(...balanceTrend, startingBalanceForMonth);
            } else {
                // balanceTrendãŒç©ºã®å ´åˆã®å‡¦ç†ã‚’æ˜ç¢ºã«ã™ã‚‹
                minBalance = startingBalanceForMonth;
                maxBalance = startingBalanceForMonth;
            }

            let yAxisMin;
            const dataRange = maxBalance - minBalance;

            if (dataRange === 0) { // å…¨ã¦ã®æ®‹é«˜ãŒåŒã˜å ´åˆ
                if (minBalance === 0) {
                    yAxisMin = -1000; // 0ã®å ´åˆã¯ä¸‹ã«å°‘ã—ä½™ç™½ã‚’æŒãŸã›ã‚‹
                } else if (minBalance > 0) {
                    yAxisMin = minBalance * 0.5; // æ­£ã®å€¤ã®å ´åˆã¯ãã®åŠåˆ†ã‚’æœ€å°å€¤ã«
                } else { // minBalance < 0
                    yAxisMin = minBalance * 1.5; // è² ã®å€¤ã®å ´åˆã¯ã•ã‚‰ã«ä¸‹ã«ä½™ç™½ã‚’
                }
            } else {
                // ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã®10%ã‚’ãƒãƒƒãƒ•ã‚¡ã¨ã—ã¦æœ€å°å€¤ã‹ã‚‰å¼•ã
                const buffer = dataRange * 0.1; 
                yAxisMin = minBalance - buffer;
            }

            // minBalanceãŒæ­£ã®å€¤ã®å ´åˆã€yAxisMinãŒ0ã‚’ä¸‹å›ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
            if (minBalance >= 0) {
                yAxisMin = Math.max(0, yAxisMin);
            }

            // ã‚°ãƒ©ãƒ•æç”»
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: daysInMonth }, (_, i) => `${i + 1}æ—¥`),
                    datasets: [{
                        label: 'å£åº§æ®‹é«˜æ¨ç§»',
                        data: balanceTrend,
                        borderColor: 'rgb(46,125,50)', // Added borderColor
                        backgroundColor: 'rgba(46,125,50,0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yAxisMin, // Yè»¸ã®æœ€å°å€¤ã‚’è¨­å®š
                            title: { display: true, text: 'æ®‹é«˜(å††)' }
                        }
                    }
                },
            });
        }

        // å ´æ‰€åˆ¥æ”¯å‡ºã‚°ãƒ©ãƒ•ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderSpendingByPlaceGraph() {
            const area = document.getElementById('spendingByPlaceGraphArea');
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
            if (spendingByPlaceChart) {
                spendingByPlaceChart.destroy();
            }
            area.innerHTML = ''; // ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢

            // ä»Šæœˆã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’å ´æ‰€ã”ã¨ã«é›†è¨ˆ
            const spendingByPlace = transactions
                .filter(t => t.date && t.date.startsWith(currentMonth) && t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.place] = (acc[t.place] || 0) + t.amount;
                    return acc;
                }, {});

            // é›†è¨ˆçµæœã‚’é…åˆ—ã«å¤‰æ›ã—ã€é‡‘é¡ã§é™é †ã‚½ãƒ¼ãƒˆ
            let sortedPlaces = Object.keys(spendingByPlace).map(place => ({
                place: place,
                amount: spendingByPlace[place]
            })).sort((a, b) => b.amount - a.amount);

            // è¡¨ç¤ºé …ç›®æ•°ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const limit = parseInt(document.getElementById('spendingPlaceLimit').value) || 10;
            sortedPlaces = sortedPlaces.slice(0, limit);

            const labels = sortedPlaces.map(item => item.place);
            const data = sortedPlaces.map(item => item.amount);

            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (labels.length === 0) {
                area.innerHTML = '<p style="text-align:center; color:#666;">ä»Šæœˆã®å ´æ‰€åˆ¥æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
            const scrollContainer = document.createElement('div');
            scrollContainer.className = 'scroll-graph-container';
            area.appendChild(scrollContainer);

            // Canvasè¦ç´ ã‚’ä½œæˆ
            const canvas = document.createElement('canvas');
            canvas.id = 'spendingByPlaceChart';
            
            // ãƒ‡ãƒ¼ã‚¿é‡ã«å¿œã˜ã¦Canvasã®å¹…ã‚’å‹•çš„ã«è¨­å®š
            // 1é …ç›®ã‚ãŸã‚Š150pxã®å¹…ã‚’ç¢ºä¿ (ãƒãƒ¼ã®å¹… + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° + ãƒ©ãƒ™ãƒ«ã‚¹ãƒšãƒ¼ã‚¹)
            const requiredWidth = labels.length * 150; 
            
            // Canvasã®æç”»ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºã‚’è¨­å®š
            // è¦ªã‚³ãƒ³ãƒ†ãƒŠã®ç¾åœ¨ã®è¡¨ç¤ºå¹…ã¨ã€ã‚°ãƒ©ãƒ•ãŒå¿…è¦ã¨ã™ã‚‹æœ€å°å¹…ã®å¤§ãã„æ–¹ã‚’ä½¿ç”¨
            canvas.width = Math.max(area.offsetWidth, requiredWidth); 
            canvas.height = 300; // æç”»ãƒãƒƒãƒ•ã‚¡ã®é«˜ã•ã¯å›ºå®š

            // Canvasã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
            canvas.style.display = 'block';
            // ã“ã“ã‚’ä¿®æ­£ï¼šcanvas.widthå±æ€§ã§è¨­å®šã—ãŸæç”»å¹…ã‚’ãã®ã¾ã¾CSSã®widthã«è¨­å®šã™ã‚‹
            canvas.style.width = `${canvas.width}px`; 
            canvas.style.height = '300px'; 

            scrollContainer.appendChild(canvas);
            const ctx = canvas.getContext('2d');


            // ã‚°ãƒ©ãƒ•æç”»
            spendingByPlaceChart = new Chart(ctx, {
                type: 'bar', // æ£’ã‚°ãƒ©ãƒ•ã‚’ä½¿ç”¨
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ”¯å‡ºé¡',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)', // æ£’ã®è‰²
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false, // Chart.jsãŒCanvasã®CSSå¹…ã§ã¯ãªãã€Canvasè¦ç´ ã®width/heightå±æ€§ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
                    maintainAspectRatio: false, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªã„
                    plugins: {
                        legend: {
                            display: false // å‡¡ä¾‹ã¯éè¡¨ç¤º
                        },
                        title: {
                            display: true,
                            text: 'å ´æ‰€åˆ¥æ”¯å‡º (ä¸Šä½' + limit + 'ä»¶)' // ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤ºé …ç›®æ•°ã‚’è¿½åŠ 
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true, // Yè»¸ã¯0ã‹ã‚‰é–‹å§‹
                            title: {
                                display: true,
                                text: 'é‡‘é¡ (å††)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å ´æ‰€'
                            },
                            // ãƒ©ãƒ™ãƒ«ãŒé‡ãªã‚‹ã®ã‚’é˜²ããŸã‚ã«å›è»¢ã•ã›ã‚‹
                            ticks: {
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 90,
                                font: {
                                    size: 10 // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function checkVariableExpensesIfNeeded() {
            const today = new Date();
            const [year, month] = currentMonth.split('-').map(Number);
            // Check if the current month is the month being viewed in the selector
            // And if today's date matches the check day
            if (today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === variableExpenseCheckDay) {
                // Prevent showing the alert multiple times in the same day
                const lastAlertDate = localStorage.getItem('lastVariableExpenseAlert');
                if (lastAlertDate !== today.toISOString().slice(0, 10)) {
                    await showAlert(`ä»Šæœˆã®å¤‰å‹•æ”¯å‡ºã¯${variableExpenseDueDay}æ—¥ã«ç™ºç”Ÿã—ã¾ã™ã€‚`);
                    localStorage.setItem('lastVariableExpenseAlert', today.toISOString().slice(0, 10));
                }
            }
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸæœˆã®å›ºå®šæ”¯å‡ºã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         * @param {string} month - YYYY-MMå½¢å¼ã®æœˆã€‚
         */
        function addFixedExpensesForMonth(month) {
            genres.filter(g => g.type === 'fixed').forEach(g => {
                const budget = budgetsByMonth[month]?.[g.name];
                const dueDay = g.dueDay || 1; // å›ºå®šè²»ã¯ã‚¸ãƒ£ãƒ³ãƒ«æŒ‡å®šãŒãªã‘ã‚Œã°1æ—¥
                if (budget) {
                    const formattedDueDay = String(dueDay).padStart(2, '0');
                    const alreadyExists = transactions.some(t => t.date === `${month}-${formattedDueDay}` && t.genre === g.name && t.memo === 'å®šæœŸæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰');
                    if (!alreadyExists) {
                        transactions.push({
                            date: `${month}-${formattedDueDay}`,
                            place: g.name,
                            type: 'expense',
                            genre: g.name,
                            amount: budget,
                            memo: 'å®šæœŸæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰',
                            tags: 'å®šæœŸ',
                            timestamp: generateUniqueId()
                        });
                    }
                }
            });
            saveData();
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸæœˆã®å¤‰å‹•æ”¯å‡ºã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         * @param {string} month - YYYY-MMå½¢å¼ã®æœˆã€‚
         */
        function addVariableExpensesForMonth(month) {
            genres.filter(g => g.type === 'variable').forEach(g => {
                const budget = budgetsByMonth[month]?.[g.name];
                const dueDay = g.dueDay || variableExpenseDueDay; // ã‚¸ãƒ£ãƒ³ãƒ«ã”ã¨ã®ç™ºç”Ÿæ—¥ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°å…¨ä½“è¨­å®š
                if (budget) {
                    const formattedDueDay = String(dueDay).padStart(2, '0');
                    const alreadyExists = transactions.some(t => t.date === `${month}-${formattedDueDay}` && t.genre === g.name && t.memo === 'å¤‰å‹•æ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰');
                    if (!alreadyExists) {
                        transactions.push({
                            date: `${month}-${formattedDueDay}`,
                            place: g.name,
                            type: 'expense',
                            genre: g.name,
                            amount: budget,
                            memo: 'å¤‰å‹•æ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰',
                            tags: 'å¤‰å‹•',
                            timestamp: generateUniqueId()
                        });
                    }
                }
            });
            saveData();
        }

        /**
         * äºˆç®—ã®ç¹°è¶Šãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨ã—ã¾ã™ã€‚
         * å‰æœˆã®äºˆç®—æ®‹é«˜ï¼ˆä½™å‰°ã¾ãŸã¯ä¸è¶³ï¼‰ã‚’å½“æœˆã®äºˆç®—ã«åæ˜ ã•ã›ã¾ã™ã€‚
         * @param {string} newMonth - å½“æœˆ (YYYY-MMå½¢å¼)ã€‚
         */
        function applyBudgetRollover(newMonth) {
            const prevMonthDate = new Date(newMonth + '-01');
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const prevMonth = prevMonthDate.toISOString().slice(0, 7);

            // å½“æœˆã®äºˆç®—ãŒã¾ã å­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!budgetsByMonth[newMonth]) {
                budgetsByMonth[newMonth] = {};
            }

            rolloverGenres.forEach(genreName => {
                const prevMonthBudget = budgetsByMonth[prevMonth]?.[genreName] || 0;
                const prevMonthSpent = transactions
                    .filter(t => t.date && t.date.startsWith(prevMonth) && t.genre === genreName && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const rolloverAmount = prevMonthBudget - prevMonthSpent;

                // å½“æœˆã®äºˆç®—ã«ç¹°è¶Šé¡ã‚’åŠ ç®—
                // å½“æœˆã«ãã®ã‚¸ãƒ£ãƒ³ãƒ«ã®äºˆç®—ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ç¹°è¶Šé¡ãŒãã®ã¾ã¾äºˆç®—ã¨ãªã‚‹
                budgetsByMonth[newMonth][genreName] = (budgetsByMonth[newMonth][genreName] || 0) + rolloverAmount;
            });
            saveData();
        }

        // --- è²¡å‹™å¥å…¨æ€§ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
        function renderFinancialHealthSection() {
            const scoreDisplay = document.getElementById('financialHealthScoreDisplay');
            const insightsDisplay = document.getElementById('financialHealthInsights');
            
            const { score, insights } = calculateFinancialHealthScoreAndInsights();

            scoreDisplay.textContent = `${Math.round(score)}ç‚¹`;
            
            if (insights.length > 0) {
                insightsDisplay.innerHTML = insights.map(insight => `<p style="margin-bottom:0.5rem;">${insight}</p>`).join('');
            } else {
                insightsDisplay.innerHTML = '<p style="text-align:center; color:#999;">ä»Šæœˆã®è²¡å‹™å¥å…¨æ€§ã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
        }

        /**
         * è²¡å‹™å¥å…¨æ€§ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
         * @returns {{score: number, insights: string[]}} ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®é…åˆ—
         */
        function calculateFinancialHealthScoreAndInsights() {
            let score = 100; // åˆæœŸã‚¹ã‚³ã‚¢
            const insights = [];
            const currentMonthExpenses = transactions.filter(t => t.date && t.date.startsWith(currentMonth) && t.type === 'expense');
            const currentMonthIncome = transactions.filter(t => t.date && t.date.startsWith(currentMonth) && t.type === 'income');

            const monthlyBudget = budgetsByMonth[currentMonth] || {};

            // 1. äºˆç®—é”æˆåº¦ (Budget Adherence)
            const currentMonthExpensesByGenre = currentMonthExpenses.reduce((acc, t) => {
                acc[t.genre] = (acc[t.genre] || 0) + t.amount;
                return acc;
            }, {});

            let totalBudget = 0;
            let totalSpent = 0;

            Object.keys(monthlyBudget).forEach(genre => {
                const budget = monthlyBudget[genre];
                const spent = currentMonthExpensesByGenre[genre] || 0;
                totalBudget += budget;
                totalSpent += spent;

                const difference = budget - spent;
                if (difference < 0) { // äºˆç®—ã‚ªãƒ¼ãƒãƒ¼
                    const overagePercentage = Math.abs(difference) / budget * 100;
                    score -= Math.min(20, Math.round(overagePercentage / 5)); // 5%ã‚ªãƒ¼ãƒãƒ¼ã”ã¨ã«1ç‚¹æ¸›ç‚¹ã€æœ€å¤§20ç‚¹
                    insights.push(`âš ï¸ ${genre}ãŒäºˆç®—ã‚’${new Intl.NumberFormat().format(Math.abs(difference))}å††ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ã¾ã™ã€‚`);
                } else if (difference > 0 && budget > 0) { // äºˆç®—å†…ã€ã‹ã¤äºˆç®—ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                    insights.push(`âœ¨ ${genre}ã§${new Intl.NumberFormat().format(difference)}å††ã®ç¯€ç´„ã«æˆåŠŸã—ã¦ã„ã¾ã™ã€‚`);
                }
            });

            // å…¨ä½“äºˆç®—ã®è©•ä¾¡
            if (totalBudget > 0) {
                const overallDifference = totalBudget - totalSpent;
                if (overallDifference < 0) {
                    const overagePercentage = Math.abs(overallDifference) / totalBudget * 100;
                    score -= Math.min(30, Math.round(overagePercentage / 3)); // å…¨ä½“äºˆç®—ã‚ªãƒ¼ãƒãƒ¼ã¯é‡ãæ¸›ç‚¹
                    insights.push(`ğŸš¨ ä»Šæœˆã¯å…¨ä½“ã§äºˆç®—ã‚’${new Intl.NumberFormat().format(Math.abs(overallDifference))}å††ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ã¾ã™ã€‚`);
                } else if (overallDifference > 0) {
                    insights.push(`âœ… ä»Šæœˆã¯å…¨ä½“ã§${new Intl.NumberFormat().format(overallDifference)}å††ã®ç¯€ç´„ãŒã§ãã¦ã„ã¾ã™ï¼`);
                }
            } else {
                insights.push('ğŸ’¡ ä»Šæœˆã®äºˆç®—ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚äºˆç®—ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šè©³ç´°ãªåˆ†æãŒå¯èƒ½ã§ã™ã€‚');
            }


            // 2. æ”¯å‡ºã®å®‰å®šæ€§ (Spending Stability) - éå»3ãƒ¶æœˆã®å¹³å‡ã¨æ¯”è¼ƒ
            const threeMonthsAgo = new Date(currentMonth + '-01');
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            const recentMonths = [];
            for (let i = 0; i < 3; i++) {
                const d = new Date(threeMonthsAgo);
                d.setMonth(d.getMonth() + i);
                recentMonths.push(d.toISOString().slice(0, 7));
            }

            const keyCategories = genres.filter(g => g.type === '').map(g => g.name); // é€šå¸¸ã‚¸ãƒ£ãƒ³ãƒ«ã‚’å¯¾è±¡
            const historicalSpending = {}; // { genre: { month: amount } }

            transactions.filter(t => recentMonths.includes(t.date.slice(0, 7)) && t.type === 'expense').forEach(t => {
                if (!historicalSpending[t.genre]) historicalSpending[t.genre] = {};
                const monthKey = t.date.slice(0, 7);
                historicalSpending[t.genre][monthKey] = (historicalSpending[t.genre][monthKey] || 0) + t.amount;
            });

            keyCategories.forEach(genre => {
                const currentSpending = currentMonthExpensesByGenre[genre] || 0;
                const pastSpendings = recentMonths.map(month => historicalSpending[genre]?.[month] || 0);
                const pastAverage = pastSpendings.reduce((sum, val) => sum + val, 0) / pastSpendings.length;

                if (pastAverage > 0 && currentSpending > pastAverage * 1.2) { // 20%ä»¥ä¸Šå¢—åŠ 
                    const increasePercentage = ((currentSpending - pastAverage) / pastAverage * 100).toFixed(0);
                    score -= Math.min(15, Math.round(increasePercentage / 10)); // 10%å¢—åŠ ã”ã¨ã«1ç‚¹æ¸›ç‚¹ã€æœ€å¤§15ç‚¹
                    insights.push(`ğŸ“ˆ ${genre}ã®æ”¯å‡ºãŒéå»3ãƒ¶æœˆå¹³å‡ã‚ˆã‚Š${increasePercentage}%å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚`);
                } else if (pastAverage > 0 && currentSpending < pastAverage * 0.8) { // 20%ä»¥ä¸Šæ¸›å°‘
                    const decreasePercentage = ((pastAverage - currentSpending) / pastAverage * 100).toFixed(0);
                    insights.push(`ğŸ“‰ ${genre}ã®æ”¯å‡ºãŒéå»3ãƒ¶æœˆå¹³å‡ã‚ˆã‚Š${decreasePercentage}%æ¸›å°‘ã—ã¦ã„ã¾ã™ã€‚ç´ æ™´ã‚‰ã—ã„ï¼`);
                }
            });

            // 3. åå…¥ã¨æ”¯å‡ºã®ãƒãƒ©ãƒ³ã‚¹ (Income vs Expense)
            const totalCurrentMonthIncome = currentMonthIncome.reduce((sum, t) => sum + t.amount, 0);
            const totalCurrentMonthExpense = currentMonthExpenses.reduce((sum, t) => sum + t.amount, 0);

            if (totalCurrentMonthIncome > 0) {
                const savingRate = (totalCurrentMonthIncome - totalCurrentMonthExpense) / totalCurrentMonthIncome * 100;
                if (savingRate < 0) {
                    score -= Math.min(20, Math.round(Math.abs(savingRate) / 2)); // èµ¤å­—ã¯é‡ãæ¸›ç‚¹
                    insights.push(`ğŸ’” ä»Šæœˆã¯${new Intl.NumberFormat().format(Math.abs(totalCurrentMonthIncome - totalCurrentMonthExpense))}å††ã®èµ¤å­—ã§ã™ã€‚æ”¯å‡ºã‚’è¦‹ç›´ã—ã¾ã—ã‚‡ã†ã€‚`);
                } else if (savingRate < 10) {
                    insights.push(`ğŸ¤” è²¯è“„ç‡ã¯${savingRate.toFixed(0)}%ã§ã™ã€‚ã‚‚ã†å°‘ã—è²¯è“„ã‚’å¢—ã‚„ã›ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`);
                } else {
                    insights.push(`ğŸ’° è²¯è“„ç‡ã¯${savingRate.toFixed(0)}%ã¨å¥å…¨ã§ã™ï¼ã“ã®èª¿å­ã§è²¯è“„ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚`);
                }
            } else {
                insights.push('ğŸ’¡ ä»Šæœˆã®åå…¥ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åå…¥ã‚’è¨˜éŒ²ã™ã‚‹ã¨ã€ã‚ˆã‚Šæ­£ç¢ºãªè²¡å‹™å¥å…¨æ€§è©•ä¾¡ãŒå¯èƒ½ã§ã™ã€‚');
            }

            // ã‚¹ã‚³ã‚¢ã‚’0-100ã®ç¯„å›²ã«åã‚ã‚‹
            score = Math.max(0, Math.min(100, score));

            // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒå°‘ãªã„å ´åˆã¯è¿½åŠ 
            if (insights.length === 0 || insights.every(i => i.startsWith('âš ï¸') || i.startsWith('ğŸš¨') || i.startsWith('ğŸ“ˆ') || i.startsWith('ğŸ’”') || i.startsWith('ğŸ¤”'))) {
                insights.push('âœ¨ ä»Šæœˆã¯å…¨ä½“çš„ã«è‰¯å¥½ãªå®¶è¨ˆç®¡ç†ãŒã§ãã¦ã„ã¾ã™ã€‚ç´ æ™´ã‚‰ã—ã„ï¼');
            }

            return { score, insights };
        }


        // --- å®šæœŸçš„ãªå–å¼•ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
        function renderRecurringTransactionsList() {
            const listDiv = document.getElementById('recurringTransactionsList');
            listDiv.innerHTML = '';
            const recurringGenres = genres.filter(g => g.type === 'fixed' || g.type === 'variable');

            if (recurringGenres.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color:#666;">å®šæœŸçš„ãªå–å¼•ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            let html = '<ul style="list-style:none; padding:0;">';
            recurringGenres.forEach(g => {
                const typeText = g.type === 'fixed' ? 'å›ºå®š' : 'å¤‰å‹•';
                const dueDay = g.dueDay || (g.type === 'fixed' ? 1 : variableExpenseDueDay); // ã‚¸ãƒ£ãƒ³ãƒ«ã”ã¨ã®ç™ºç”Ÿæ—¥ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                const dueDayText = `æ¯æœˆ${dueDay}æ—¥` + (g.dueDay ? '' : ' (å…¨ä½“è¨­å®š)');
                const budget = budgetsByMonth[currentMonth]?.[g.name] || 0;
                const transactionExists = transactions.some(t => 
                    t.date && t.date.startsWith(currentMonth) && 
                    t.genre === g.name && 
                    (t.memo === 'å®šæœŸæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰' || t.memo === 'å¤‰å‹•æ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰')
                );
                const statusText = transactionExists ? '<span style="color:green;">âœ” ç”Ÿæˆæ¸ˆã¿</span>' : '<span style="color:orange;">æœªç”Ÿæˆ</span>';

                html += `
                    <li style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed var(--border-color-light);">
                        <div>
                            <strong>${g.name}</strong> (${typeText}) - ç™ºç”Ÿæ—¥: ${dueDayText}<br>
                            <span style="font-size:0.9rem; color:#666;">ä»Šæœˆã®äºˆç®—: ${new Intl.NumberFormat().format(budget)}å††</span>
                        </div>
                        <div>${statusText}</div>
                    </li>
                `;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
        }

        // --- DOMèª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            document.getElementById('homeTab').addEventListener('click', () => switchTab('home'));
            document.getElementById('settingsTab').addEventListener('click', () => switchTab('settings'));
            document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
            document.getElementById('add-split-item-btn').addEventListener('click', () => addSplitItemRow(document.getElementById('split-items-container')));
            
            // å ´æ‰€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ã‚¸ãƒ£ãƒ³ãƒ«ã‚’è‡ªå‹•è£œå®Œ
            document.getElementById('place').addEventListener('input', (e) => {
                const placeInput = e.target.value.trim();
                if (placeInput && placeGenreMap[placeInput]) {
                    const genresForPlace = placeGenreMap[placeInput];
                    let bestGenre = '';
                    let maxCount = 0;
                    for (const genre in genresForPlace) {
                        if (genresForPlace[genre] > maxCount) {
                            maxCount = genresForPlace[genre];
                            bestGenre = genre;
                        }
                    }
                    if (bestGenre) {
                        // æ—¢å­˜ã®åˆ†å‰²é …ç›®ãŒã‚ã‚Œã°ã€ãã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’æ›´æ–°
                        const firstSplitGenreSelect = document.querySelector('.split-genre');
                        if (firstSplitGenreSelect) {
                            firstSplitGenreSelect.value = bestGenre;
                        }
                    }
                }
            });

            document.getElementById('addGenreBtn').addEventListener('click', addGenre);
            document.getElementById('setBudgetBtn').addEventListener('click', setBudget);
            document.getElementById('copyBudgetBtn').addEventListener('click', copyLastMonthBudget);
            document.getElementById('monthSelector').addEventListener('change', e => {
                const newMonth = e.target.value;
                if (newMonth !== currentMonth) {
                    currentMonth = newMonth;
                    applyBudgetRollover(currentMonth); // äºˆç®—ç¹°è¶Šã‚’é©ç”¨
                    addFixedExpensesForMonth(currentMonth); // å›ºå®šè²»ã‚’è¿½åŠ 
                    addVariableExpensesForMonth(currentMonth); // å¤‰å‹•è²»ã‚’è¿½åŠ 
                    renderApp();
                }
            });
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataButton').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', e => importData(e.target.files[0]));
            
            const apiKeyInput = document.getElementById('apiKeyInput');
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('saveApiKeyBtn').addEventListener('click', async () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    await showAlert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                } else {
                    await showAlert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
            });

            document.getElementById('process-receipts-btn').addEventListener('click', handleReceiptProcessing);
            document.getElementById('authorize_button').addEventListener('click', () => handleAuthClick(false));
            document.getElementById('signout_button').addEventListener('click', handleSignoutClick);
            document.getElementById('backup_button').addEventListener('click', backupToDrive);
            document.getElementById('restore_button').addEventListener('click', restoreFromDrive);
            
            document.getElementById('monthlyReportBtn').addEventListener('click', () => {
                const area = document.getElementById('monthlyReportArea');
                area.style.display = area.style.display === 'block' ? 'none' : 'block'; // ãƒˆã‚°ãƒ«è¡¨ç¤º
                if (area.style.display === 'block') {
                   updateBudgetTable(); // ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’æ›´æ–°
                   area.innerHTML = document.getElementById('budgetTableArea').innerHTML;
                }
            });

            document.getElementById('saveAccountBalanceBtn').addEventListener('click', async () => {
                const val = parseInt(document.getElementById('accountBalanceInput').value);
                if (!isNaN(val)) {
                    accountBalance = val;
                    saveData();
                    await showAlert('å£åº§æ®‹é«˜ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    renderBalanceGraph();
                } else {
                    await showAlert('æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
            });
            
            document.getElementById('saveVariableExpenseCheckDayBtn').addEventListener('click', async () => {
                const val = parseInt(document.getElementById('variableExpenseCheckDay').value);
                if (!isNaN(val) && val >= 1 && val <= 31) {
                    variableExpenseCheckDay = val;
                    saveData();
                    document.getElementById('variableExpenseStatus').textContent = `å¤‰å‹•æ”¯å‡ºã®ç™ºç”Ÿæ—¥ã¯ã€å„ã‚¸ãƒ£ãƒ³ãƒ«ã§è¨­å®šã•ã‚ŒãŸæ—¥ä»˜ï¼ˆæœªè¨­å®šã®å ´åˆã¯æ¯æœˆ${variableExpenseDueDay}æ—¥ï¼‰ã§ã™ã€‚`;
                    await showAlert('å¤‰å‹•æ”¯å‡ºç¢ºèªæ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                } else {
                    await showAlert('1ï½31ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
            });

            document.getElementById('saveVariableExpenseDueDayBtn').addEventListener('click', async () => {
                const val = parseInt(document.getElementById('variableExpenseDueDay').value);
                if (!isNaN(val) && val >= 1 && val <= 31) {
                    variableExpenseDueDay = val;
                    localStorage.setItem('variableExpenseDueDay', val);
                    document.getElementById('variableExpenseStatus').textContent = `å¤‰å‹•æ”¯å‡ºã®ç™ºç”Ÿæ—¥ã¯ã€å„ã‚¸ãƒ£ãƒ³ãƒ«ã§è¨­å®šã•ã‚ŒãŸæ—¥ä»˜ï¼ˆæœªè¨­å®šã®å ´åˆã¯æ¯æœˆ${variableExpenseDueDay}æ—¥ï¼‰ã§ã™ã€‚`;
                    await showAlert('å¤‰å‹•æ”¯å‡ºã®ç™ºç”Ÿæ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                } else {
                    await showAlert('1ï½31ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
            });

            // ã€Œä»Šæœˆã®å®šæœŸå–å¼•ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('generateRecurringTransactionsBtn').addEventListener('click', async () => {
                const confirmed = await showConfirm(`ä»Šæœˆï¼ˆ${currentMonth}ï¼‰ã®å®šæœŸå–å¼•ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ`);
                if (confirmed) {
                    addFixedExpensesForMonth(currentMonth);
                    addVariableExpensesForMonth(currentMonth);
                    renderApp();
                    await showAlert('ä»Šæœˆã®å®šæœŸå–å¼•ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
                }
            });

            // ä¸¦ã¹æ›¿ãˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('budgetSortBy').addEventListener('change', (e) => {
                budgetSortColumn = e.target.value;
                renderApp();
            });

            document.getElementById('budgetSortDirection').addEventListener('click', (e) => {
                budgetSortDirection = budgetSortDirection === 'asc' ? 'desc' : 'asc';
                e.target.textContent = budgetSortDirection === 'asc' ? 'â–²' : 'â–¼';
                renderApp();
            });

            // å ´æ‰€åˆ¥æ”¯å‡ºã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºé …ç›®æ•°æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('updateSpendingPlaceGraphBtn').addEventListener('click', () => {
                const newLimit = parseInt(document.getElementById('spendingPlaceLimit').value);
                if (!isNaN(newLimit) && newLimit > 0) {
                    spendingPlaceLimit = newLimit;
                    renderSpendingByPlaceGraph(); // ã‚°ãƒ©ãƒ•ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                } else {
                    showAlert('æœ‰åŠ¹ãªè¡¨ç¤ºé …ç›®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1ä»¥ä¸Šã®æ•°å€¤)ã€‚');
                }
            });


            const container = document.getElementById('split-items-container');
            addSplitItemRow(container);
            updateSplitTotal();
            document.getElementById('date').valueAsDate = new Date();
            
            // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«å›ºå®šè²»ã¨å¤‰å‹•è²»ã‚’ãƒã‚§ãƒƒã‚¯
            addFixedExpensesForMonth(currentMonth);
            addVariableExpensesForMonth(currentMonth);
            switchTab('home');
            renderApp();
        });

        function editTransaction(timestamp) {
            const transaction = transactions.find(t => t.timestamp === timestamp);
            if (!transaction) return;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('editTransactionModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('editDate').value = transaction.date || '';
            document.getElementById('editPlace').value = transaction.place || '';
            document.getElementById('editAmount').value = transaction.amount || 0;
            document.getElementById('editMemo').value = transaction.memo || '';
            document.getElementById('editTags').value = transaction.tags || '';

            // ã‚¸ãƒ£ãƒ³ãƒ«ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const genreSelect = document.getElementById('editGenre');
            genreSelect.innerHTML = '';
            genres.forEach(g => {
                const option = document.createElement('option');
                option.value = g.name;
                option.textContent = g.name;
                if (g.name === transaction.genre) option.selected = true;
                genreSelect.appendChild(option);
            });

            // ä¿å­˜ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’è¨­å®š
            const form = document.getElementById('editTransactionForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                saveEditedTransaction(timestamp);
            };

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’è¨­å®š
            document.getElementById('cancelEditBtn').onclick = () => {
                document.getElementById('editTransactionModal').style.display = 'none';
                document.getElementById('modalOverlay').style.display = 'none';
            };
        }

        async function saveEditedTransaction(timestamp) {
            const transaction = transactions.find(t => t.timestamp === timestamp);
            if (!transaction) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            transaction.date = document.getElementById('editDate').value;
            transaction.place = document.getElementById('editPlace').value;
            transaction.amount = parseInt(document.getElementById('editAmount').value);
            transaction.memo = document.getElementById('editMemo').value; // Added memo
            transaction.tags = document.getElementById('editTags').value; // Added tags
            transaction.genre = document.getElementById('editGenre').value; // Added genre

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦UIã‚’æ›´æ–°
            saveData();
            renderApp();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('editTransactionModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';

            await showAlert('å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
        }

        function openEditGenreModal(index) {
            const genre = genres[index];
            if (!genre) return;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('editGenreModal').style.display = 'block';
            document.getElementById('editGenreOverlay').style.display = 'block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('editGenreName').value = genre.name || '';
            document.getElementById('editGenreType').value = genre.type || '';
            document.getElementById('editGenreDueDay').value = genre.dueDay || '';

            // ä¿å­˜ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’è¨­å®š
            const form = document.getElementById('editGenreForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                saveEditedGenre(index);
            };

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’è¨­å®š
            document.getElementById('cancelEditGenreBtn').onclick = () => {
                document.getElementById('editGenreModal').style.display = 'none';
                document.getElementById('editGenreOverlay').style.display = 'none';
            };
        }

        async function saveEditedGenre(index) {
            const genre = genres[index];
            if (!genre) return;

            const oldName = genre.name;
            const newName = document.getElementById('editGenreName').value.trim();
            const newType = document.getElementById('editGenreType').value;
            const newDueDay = parseInt(document.getElementById('editGenreDueDay').value) || null;

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            genre.name = newName;
            genre.type = newType;
            genre.dueDay = newDueDay;

            // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            transactions.forEach(t => {
                if (t.genre === oldName) t.genre = newName;
            });

            Object.keys(budgetsByMonth).forEach(month => {
                if (budgetsByMonth[month][oldName]) {
                    budgetsByMonth[month][newName] = budgetsByMonth[month][oldName];
                    delete budgetsByMonth[month][oldName];
                }
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦UIã‚’æ›´æ–°
            saveData();
            renderApp();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('editGenreModal').style.display = 'none';
            document.getElementById('editGenreOverlay').style.display = 'none';

            await showAlert('ã‚¸ãƒ£ãƒ³ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
        }
    </script>
</body>
</html>
